<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Radio Globe Pro</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/globe.gl"></script>
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: sans-serif; }
        
        #loader {
            position: fixed; top: 20px; right: 20px; z-index: 1000;
            background: rgba(0, 255, 136, 0.2); color: #00ff88;
            padding: 8px 15px; border-radius: 20px; font-size: 12px;
            border: 1px solid #00ff88; display: none;
        }

        #side-drawer {
            position: fixed; top: 0; left: -320px; width: 300px; height: 100%;
            background: rgba(10, 10, 10, 0.95); z-index: 1002; transition: 0.3s;
            display: flex; flex-direction: column; border-right: 1px solid #333;
            color: white; backdrop-filter: blur(10px);
        }
        #side-drawer.open { left: 0; }

        #stations-list { flex: 1; overflow-y: auto; padding: 20px; margin-top: 40px; }
        .city-name { font-size: 20px; color: #00ff88; font-weight: bold; margin-bottom: 15px; }
        .station-item { 
            padding: 12px; background: #1a1a1a; border-radius: 8px; 
            margin-bottom: 8px; cursor: pointer; font-size: 14px; 
        }

        #player {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 85%; background: #111; padding: 15px; border-radius: 15px;
            display: none; z-index: 1003; border: 1px solid #444; color: white;
        }
    </style>
</head>
<body>

    <div id="loader">Поиск городов...</div>
    <div id="globeViz"></div>

    <div id="side-drawer">
        <div id="stations-list"></div>
    </div>

    <div id="player">
        <div id="now-playing" style="font-size: 12px; margin-bottom: 8px; color: #00ff88;"></div>
        <audio id="audio-player" controls style="width: 100%;"></audio>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready(); tg.expand();

        let foundCities = new Map();
        let searchCtrl = null;

        // Инициализация Глобуса
        const world = Globe()(document.getElementById('globeViz'))
            .globeImageUrl('//unpkg.com/three-globe/example/img/earth-night.jpg')
            .backgroundColor('#000000')
            .showAtmosphere(true)
            // Настройка точек (WebGL слой)
            .pointsData([])
            .pointRadius(0.7) // Фиксированный размер
            .pointColor(() => '#00ff88')
            .pointAltitude(0) // Плоские точки
            .pointLabel(d => d.name)
            .onPointClick(d => openCity(d));

        // Границы масштаба
        const controls = world.controls();
        controls.minDistance = 120; 
        controls.maxDistance = 700;
        controls.enableDamping = true;

        // Запуск поиска при движении
        controls.addEventListener('change', debounce(() => {
            performMultiStepSearch();
        }, 500));

        async function performMultiStepSearch() {
            const { lat, lng } = world.pointOfView();
            const loader = document.getElementById('loader');
            
            if (searchCtrl) searchCtrl.abort();
            searchCtrl = new AbortController();

            loader.style.display = 'block';
            
            // 4 итерации: от 2000км до 100км
            const steps = [2000, 800, 300, 100];
            
            for (let radius of steps) {
                if (searchCtrl.signal.aborted) break;
                
                try {
                    const url = `https://de1.api.radio-browser.info/json/stations/search?lat=${lat}&lon=${lng}&radius=${radius}&limit=60&hidebroken=true&order=clickcount&reverse=true`;
                    const res = await fetch(url, { signal: searchCtrl.signal });
                    const data = await res.json();
                    
                    data.forEach(s => {
                        // Ключ по координатам, чтобы не дублировать точки в одном городе
                        const key = `${s.geo_lat.toFixed(1)}_${s.geo_long.toFixed(1)}`;
                        if (!foundCities.has(key)) {
                            foundCities.set(key, {
                                lat: s.geo_lat,
                                lng: s.geo_long,
                                name: s.state || s.country || "Город",
                                id: s.stationuuid
                            });
                        }
                    });

                    // Обновляем точки на глобусе
                    world.pointsData(Array.from(foundCities.values()));
                    loader.innerText = `Найдено: ${foundCities.size} городов`;
                    
                } catch (e) {
                    if (e.name !== 'AbortError') console.error(e);
                }
            }
            loader.style.display = 'none';
        }

        async function openCity(city) {
            const list = document.getElementById('stations-list');
            document.getElementById('side-drawer').classList.add('open');
            list.innerHTML = `<div class="city-name">${city.name}</div><div style="color: #666">Загрузка станций...</div>`;

            try {
                const res = await fetch(`https://de1.api.radio-browser.info/json/stations/search?lat=${city.lat}&lon=${city.lng}&radius=30&limit=100&hidebroken=true&order=clickcount&reverse=true`);
                const stations = await res.json();
                
                list.innerHTML = `<div class="city-name">${city.name}</div>`;
                stations.forEach(s => {
                    const div = document.createElement('div');
                    div.className = 'station-item';
                    div.innerText = s.name;
                    div.onclick = () => {
                        const player = document.getElementById('player');
                        const audio = document.getElementById('audio-player');
                        player.style.display = 'block';
                        document.getElementById('now-playing').innerText = `Эфир: ${s.name}`;
                        audio.src = s.url_resolved.replace('http://', 'https://');
                        audio.play();
                    };
                    list.appendChild(div);
                });
            } catch (e) { list.innerHTML = "Ошибка загрузки"; }
        }

        function debounce(f, ms) {
            let t; return (...a) => { clearTimeout(t); t = setTimeout(() => f.apply(this, a), ms); };
        }

        // Клик по глобусу закрывает меню
        world.onGlobeClick(() => document.getElementById('side-drawer').classList.remove('open'));

        // Первый запуск при загрузке
        setTimeout(performMultiStepSearch, 1000);
    </script>
</body>
