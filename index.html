<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Radio Pro: Ultra Zoom</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/globe.gl"></script>
    <style>
        body { margin: 0; background: #000; color: white; font-family: -apple-system, system-ui, sans-serif; overflow: hidden; }
        
        #search-loader {
            position: fixed; top: 20px; right: 20px; z-index: 2000;
            background: rgba(0, 150, 255, 0.2); color: #00aaff;
            padding: 8px 15px; border-radius: 20px; font-size: 12px;
            border: 1px solid #00aaff; display: none; backdrop-filter: blur(8px);
        }

        #menu-btn { 
            position: fixed; top: 20px; left: 20px; z-index: 1001; 
            background: rgba(34,34,34,0.8); border-radius: 50%; width: 44px; height: 44px; 
            display: flex; align-items: center; justify-content: center; 
            border: 1px solid #444; color: white; cursor: pointer;
        }
        
        #side-drawer {
            position: fixed; top: 0; left: -320px; width: 300px; height: 100%;
            background: rgba(10, 10, 10, 0.95); z-index: 1002; transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1); 
            display: flex; flex-direction: column; border-right: 1px solid #333;
            backdrop-filter: blur(10px);
        }
        #side-drawer.open { left: 0; }

        #stations-list { flex: 1; overflow-y: auto; padding: 20px; margin-top: 50px; }
        .city-header { font-size: 22px; color: #00ff88; font-weight: bold; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 1px; }
        .station-item { 
            padding: 15px; border-radius: 12px; margin-bottom: 8px; 
            background: rgba(255,255,255,0.05); cursor: pointer; font-size: 14px;
            transition: 0.2s; border: 1px solid transparent;
        }
        .station-item:hover { background: rgba(0, 255, 136, 0.1); border-color: #00ff88; }

        #player {
            position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%);
            width: 85%; background: rgba(20, 20, 20, 0.9); padding: 15px; 
            border-radius: 20px; border: 1px solid #444; display: none; z-index: 1003;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
    </style>
</head>
<body>

    <div id="search-loader">üì° –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ...</div>
    <div id="menu-btn" onclick="toggleMenu()">‚ò∞</div>
    
    <div id="globeViz"></div>

    <div id="side-drawer">
        <div id="stations-list"></div>
    </div>

    <div id="player">
        <div id="current-name" style="font-size: 13px; color: #00ff88; margin-bottom: 10px; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;"></div>
        <audio id="audio-player" controls style="width: 100%; height: 35px;"></audio>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready(); tg.expand();

        let foundCities = new Map();
        let currentSearchAbort = null;
        let activeCityId = null;

        const world = Globe()(document.getElementById('globeViz'))
            .globeImageUrl('//unpkg.com/three-globe/example/img/earth-night.jpg')
            .bumpImageUrl('//unpkg.com/three-globe/example/img/earth-topology.png')
            .backgroundColor('#000000')
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–ª–µ—Ü –¥–ª—è –≥–æ—Ä–æ–¥–æ–≤
            .ringsData([])
            .ringColor(() => '#00ff88')
            .ringMaxRadius(1.5)
            .ringPropagationSpeed(1)
            .ringRepeatPeriod(1000)
            // –¢–æ—á–∫–∏ –∫–∞–∫ —Ü–µ–Ω—Ç—Ä—ã –≥–æ—Ä–æ–¥–æ–≤
            .pointsData([])
            .pointRadius(d => d.id === activeCityId ? 1.2 : 0.5)
            .pointColor(d => d.id === activeCityId ? '#ffa500' : '#00ff88')
            .onPointClick(d => loadCityDetails(d));

        // –†–ê–°–®–ò–†–ï–ù–ù–´–ï –ì–†–ê–ù–ò–¶–´ –ú–ê–°–®–¢–ê–ë–ê
        const ctrl = world.controls();
        ctrl.minDistance = 110; // –ü–æ—á—Ç–∏ –≤–ø–ª–æ—Ç–Ω—É—é –∫ –≥–æ—Ä–æ–¥–∞–º
        ctrl.maxDistance = 800; // –í–µ—Å—å –∑–µ–º–Ω–æ–π —à–∞—Ä —Å –∑–∞–ø–∞—Å–æ–º
        ctrl.autoRotate = false;
        ctrl.enableDamping = true;
        ctrl.dampingFactor = 0.05;

        ctrl.addEventListener('change', debounce(() => {
            startMultiStepSearch();
        }, 600));

        async function startMultiStepSearch() {
            const { lat, lng, alt } = world.pointOfView();
            const loader = document.getElementById('search-loader');
            
            if (currentSearchAbort) currentSearchAbort.abort();
            currentSearchAbort = new AbortController();

            loader.style.display = 'block';
            
            // –ò—Ç–µ—Ä–∞—Ü–∏–∏ –ø–æ —Ä–∞–¥–∏—É—Å—É (–∫–º)
            const iterations = [3000, 1200, 500, 150, 40];
            
            for (let i = 0; i < iterations.length; i++) {
                if (currentSearchAbort.signal.aborted) break;
                
                const radius = iterations[i];
                const offset = i * 80;
                
                try {
                    const res = await fetch(
                        `https://de1.api.radio-browser.info/json/stations/search?lat=${lat}&lon=${lng}&radius=${radius}&limit=80&offset=${offset}&hidebroken=true&order=clickcount&reverse=true`,
                        { signal: currentSearchAbort.signal }
                    );
                    const stations = await res.json();
                    
                    stations.forEach(s => {
                        const key = `${s.geo_lat.toFixed(2)}_${s.geo_long.toFixed(2)}`;
                        if (!foundCities.has(key)) {
                            foundCities.set(key, {
                                lat: s.geo_lat,
                                lng: s.geo_long,
                                name: s.state || s.country || "Unknown",
                                id: s.stationuuid
                            });
                        }
                    });
                    
                    const data = Array.from(foundCities.values());
                    world.pointsData(data);
                    // –î–æ–±–∞–≤–ª—è–µ–º –ø—É–ª—å—Å–∞—Ü–∏—é —Ç–æ–ª—å–∫–æ –¥–ª—è –±–ª–∏–∂–∞–π—à–∏—Ö –≥–æ—Ä–æ–¥–æ–≤ (—á—Ç–æ–±—ã –Ω–µ –ª–∞–≥–∞–ª–æ)
                    if (alt < 1.5) {
                        world.ringsData(data.slice(-50)); 
                    }
                    
                    loader.innerText = `–ù–∞–π–¥–µ–Ω–æ: ${foundCities.size} –≥–æ—Ä–æ–¥–æ–≤`;
                } catch (e) { if (e.name !== 'AbortError') console.error(e); }
            }
            loader.style.display = 'none';
        }

        async function loadCityDetails(city) {
            activeCityId = city.id;
            world.pointsData([...world.pointsData()]); // –û–±–Ω–æ–≤–∏—Ç—å —Ü–≤–µ—Ç–∞
            
            const drawer = document.getElementById('side-drawer');
            const list = document.getElementById('stations-list');
            
            drawer.classList.add('open');
            list.innerHTML = `<div class="city-header">${city.name}</div><div style="color:#666">–ó–∞–≥—Ä—É–∑–∫–∞ —ç—Ñ–∏—Ä–∞...</div>`;

            try {
                const res = await fetch(`https://de1.api.radio-browser.info/json/stations/search?lat=${city.lat}&lon=${city.lng}&radius=25&limit=150&hidebroken=true&order=clickcount&reverse=true`);
                const data = await res.json();
                
                list.innerHTML = `<div class="city-header">${city.name}</div>`;
                data.forEach(s => {
                    const div = document.createElement('div');
                    div.className = 'station-item';
                    div.innerHTML = `<strong>${s.name}</strong><br><small style="color:#888">${s.bitrate || '?'} kbps ‚Ä¢ ${s.tags || 'radio'}</small>`;
                    div.onclick = () => {
                        const player = document.getElementById('player');
                        const audio = document.getElementById('audio-player');
                        player.style.display = 'block';
                        document.getElementById('current-name').innerText = `‚ñ∂ ${s.name}`;
                        audio.src = s.url_resolved.replace('http://', 'https://');
                        audio.play();
                    };
                    list.appendChild(div);
                });
            } catch (e) { list.innerHTML = "–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏"; }
        }

        function toggleMenu() { document.getElementById('side-drawer').classList.toggle('open'); }
        function debounce(f, ms) { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => f.apply(this, a), ms); }; }
        world.onGlobeClick(() => document.getElementById('side-drawer').classList.remove('open'));
        
        setTimeout(startMultiStepSearch, 1000);
    </script>
</body>
</html>
