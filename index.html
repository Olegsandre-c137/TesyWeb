<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Radio Pro Lite + Scanner</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://unpkg.com/globe.gl"></script>

<style>
body {
  margin: 0;
  background: #000;
  color: white;
  font-family: -apple-system, system-ui, sans-serif;
  overflow: hidden;
}

#scanner-info {
  position: fixed;
  top: 15px;
  right: 15px;
  background: rgba(0,255,136,0.2);
  color: #00ff88;
  padding: 5px 12px;
  border-radius: 15px;
  font-size: 10px;
  font-weight: bold;
  z-index: 1001;
  border: 1px solid rgba(0,255,136,0.3);
}

.station-dot {
  width: 7px;
  height: 7px;
  background: #00ff88;
  border-radius: 50%;
  transform: translate(-50%, -50%);
  border: 1px solid rgba(0,0,0,0.5);
  cursor: pointer;
}

.station-dot.cluster {
  background: #2aa;
  width: 10px;
  height: 10px;
}

.station-dot.active {
  background: #ffa500 !important;
  width: 10px;
  height: 10px;
  z-index: 1000;
}

#menu-btn {
  position: fixed;
  top: 65px;
  left: 15px;
  z-index: 1001;
  background: #222;
  border-radius: 50%;
  width: 44px;
  height: 44px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  border: 1px solid #444;
}

#side-drawer {
  position: fixed;
  top: 0;
  left: -280px;
  width: 260px;
  height: 100%;
  background: #0d0d0d;
  z-index: 1002;
  transition: 0.3s ease;
  display: flex;
  flex-direction: column;
  border-right: 1px solid #333;
}
#side-drawer.open { left: 0; }

.drawer-header { padding: 20px; margin-top: 40px; }
#search-input {
  width: 100%;
  padding: 10px;
  border-radius: 8px;
  border: 1px solid #444;
  background: #111;
  color: #fff;
}

#stations-list { flex: 1; overflow-y: auto; padding: 10px; }

.city-group {
  margin-bottom: 8px;
  background: #1a1a1a;
  border-radius: 8px;
  border: 1px solid #333;
}

.city-name {
  padding: 10px;
  font-size: 14px;
  cursor: pointer;
  display: flex;
  justify-content: space-between;
}

.station-sub-item {
  padding: 10px;
  font-size: 12px;
  border-top: 1px solid #222;
  color: #bbb;
  cursor: pointer;
}
.station-sub-item:hover { background: #222; color: #fff; }
</style>
</head>

<body>

<div id="scanner-info">ГОРОДОВ: 0</div>
<div id="menu-btn">☰</div>
<div id="globeViz"></div>

<div id="side-drawer">
  <div class="drawer-header">
    <input id="search-input" placeholder="Поиск города">
  </div>
  <div id="stations-list"></div>
</div>

<audio id="audio-player"></audio>

<script>
const tg = window.Telegram.WebApp;
tg.ready(); tg.expand();

let allGroups = [];
let offset = 0;
let currentActiveGroupKey = null;

const world = Globe()(document.getElementById('globeViz'))
  .globeImageUrl('//unpkg.com/three-globe/example/img/earth-night.jpg')
  .backgroundColor('#000')
  .showAtmosphere(false)
  .htmlElementsData([])
  .htmlElement(d => {
    const el = document.createElement('div');
    el.className = 'station-dot';
    if (d.isCluster) el.classList.add('cluster');

    const key = (d.city + d.lat).toLowerCase();
    if (key === currentActiveGroupKey) el.classList.add('active');

    el.onclick = () => {
      if (d.isCluster) {
        world.pointOfView(
          { lat: d.lat, lng: d.lng, alt: world.pointOfView().alt * 0.6 },
          600
        );
      } else {
        openCity(d);
      }
    };
    return el;
  });

world.controls().autoRotate = false;
world.renderer().setPixelRatio(window.devicePixelRatio);

/* ===== OPTIMIZATION ===== */

const CLUSTER_SIZE = 24;

function isVisible(lat, lng) {
  const cam = world.camera().position;
  const phi = lat * Math.PI / 180;
  const theta = lng * Math.PI / 180;
  const x = Math.cos(phi) * Math.cos(theta);
  const y = Math.sin(phi);
  const z = Math.cos(phi) * Math.sin(theta);
  return (x*cam.x + y*cam.y + z*cam.z) > 0;
}

function buildClusters() {
  const map = new Map();
  const cam = world.camera();
  const r = world.renderer().domElement;

  allGroups.forEach(g => {
    if (!isVisible(g.lat, g.lng)) return;
    const v = world.getCoords(g.lat, g.lng);
    v.project(cam);

    const x = (v.x * 0.5 + 0.5) * r.width;
    const y = (-v.y * 0.5 + 0.5) * r.height;

    const gx = Math.floor(x / CLUSTER_SIZE);
    const gy = Math.floor(y / CLUSTER_SIZE);
    const key = gx + ':' + gy;

    if (!map.has(key)) {
      map.set(key, { ...g, isCluster: false, count: 1 });
    } else {
      const c = map.get(key);
      c.isCluster = true;
      c.count++;
    }
  });

  world.htmlElementsData([...map.values()]);
}

let raf = false;
world.controls().addEventListener('change', () => {
  if (raf) return;
  raf = true;
  requestAnimationFrame(() => {
    buildClusters();
    raf = false;
  });
});

/* ===== DATA SCAN ===== */

async function scan() {
  const res = await fetch(
    `https://de1.api.radio-browser.info/json/stations/search?limit=1000&offset=${offset}&has_geo_info=true`
  );
  const data = await res.json();
  if (!data || !data.length) return;

  data.forEach(s => {
    const lat = parseFloat(s.geo_lat);
    const lng = parseFloat(s.geo_long);
    const city = s.state || s.country || 'Unknown';

    let g = allGroups.find(x =>
      Math.abs(x.lat - lat) < 0.3 &&
      Math.abs(x.lng - lng) < 0.3
    );

    if (!g) {
      allGroups.push({ city, lat, lng, stations: [s] });
    } else if (!g.stations.find(st => st.stationuuid === s.stationuuid)) {
      g.stations.push(s);
    }
  });

  document.getElementById('scanner-info').innerText =
    `ГОРОДОВ: ${allGroups.length}`;

  buildClusters();
  offset += 1000;
}

scan();
setInterval(scan, 4000);

/* ===== UI ===== */

function openCity(g) {
  currentActiveGroupKey = (g.city + g.lat).toLowerCase();
  world.pointOfView({ lat: g.lat, lng: g.lng, alt: 1.2 }, 600);
  renderList([g]);
  document.getElementById('side-drawer').classList.add('open');
}

function renderList(data) {
  const list = document.getElementById('stations-list');
  list.innerHTML = '';
  data.forEach(g => {
    const div = document.createElement('div');
    div.className = 'city-group';
    div.innerHTML = `<div class="city-name">${g.city}</div>`;
    g.stations.forEach(s => {
      const si = document.createElement('div');
      si.className = 'station-sub-item';
      si.innerText = s.name;
      si.onclick = () => {
        const audio = document.getElementById('audio-player');
        audio.src = s.url_resolved.replace('http://','https://');
        audio.play();
      };
      div.appendChild(si);
    });
    list.appendChild(div);
  });
}

document.getElementById('menu-btn').onclick = () =>
  document.getElementById('side-drawer').classList.toggle('open');
</script>

</body>
</html>
