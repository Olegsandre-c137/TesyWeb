<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Radio Globe Final</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/globe.gl"></script>
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: -apple-system, system-ui, sans-serif; }
        
        #ui-status {
            position: fixed; top: 15px; right: 15px; z-index: 1000;
            background: rgba(0, 255, 136, 0.15); color: #00ff88;
            padding: 8px 15px; border-radius: 20px; font-size: 11px;
            border: 1px solid #00ff88; backdrop-filter: blur(10px); display: none;
        }

        #side-drawer {
            position: fixed; top: 0; left: -320px; width: 300px; height: 100%;
            background: rgba(10, 10, 10, 0.98); z-index: 1002; transition: 0.3s ease;
            display: flex; flex-direction: column; border-right: 1px solid #333; color: white;
        }
        #side-drawer.open { left: 0; }

        #stations-list { flex: 1; overflow-y: auto; padding: 20px; margin-top: 50px; }
        .city-title { font-size: 20px; color: #00ff88; margin-bottom: 20px; font-weight: bold; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .station-card { 
            padding: 15px; background: #1a1a1a; border-radius: 12px; 
            margin-bottom: 10px; cursor: pointer; border: 1px solid #333;
        }
        .station-card:active { background: #333; border-color: #00ff88; }

        #player-bar {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 85%; background: #111; padding: 15px; border-radius: 20px;
            display: none; z-index: 1003; border: 1px solid #444; color: white;
        }
    </style>
</head>
<body>

    <div id="ui-status">–ü–û–ò–°–ö...</div>
    <div id="globeViz"></div>

    <div id="side-drawer">
        <div id="stations-list"></div>
    </div>

    <div id="player-bar">
        <div id="station-label" style="font-size: 12px; margin-bottom: 10px; color: #00ff88;"></div>
        <audio id="audio-ctrl" controls style="width: 100%; height: 35px;"></audio>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready(); tg.expand();

        let knownCities = []; // –ë–∞–∑–∞ –≥–æ—Ä–æ–¥–æ–≤
        let abortController = null;

        const world = Globe()(document.getElementById('globeViz'))
            .globeImageUrl('//unpkg.com/three-globe/example/img/earth-night.jpg')
            .backgroundColor('#000000')
            .showAtmosphere(true)
            .pointsData([]) // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Å–ª–æ–π —Ç–æ—á–µ–∫
            .pointRadius(0.8) // –†–∞–∑–º–µ—Ä —Ç–æ—á–∫–∏
            .pointColor(() => '#00ff88')
            .pointAltitude(0) // –ü–ª–æ—Å–∫–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–∞ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏
            .onPointClick(city => openCityStations(city));

        const controls = world.controls();
        controls.minDistance = 105; 
        controls.maxDistance = 700;

        controls.addEventListener('change', debounce(() => {
            runSearchCycle();
        }, 800));

        // –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞ –¥–∏—Å—Ç–∞–Ω—Ü–∏–∏ –¥–ª—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) ** 2 + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) ** 2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        async function runSearchCycle() {
            const { lat, lng } = world.pointOfView();
            const status = document.getElementById('ui-status');
            
            if (abortController) abortController.abort();
            abortController = new AbortController();

            status.style.display = 'block';
            
            // 4 –∏—Ç–µ—Ä–∞—Ü–∏–∏: –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º 100 —Å—Ç–∞–Ω—Ü–∏–π —Å —Ä–∞–∑–Ω—ã–º —Ä–∞–¥–∏—É—Å–æ–º
            const radii = [2000, 800, 300, 60];
            
            for (let i = 0; i < radii.length; i++) {
                if (abortController.signal.aborted) break;
                
                try {
                    const res = await fetch(`https://de1.api.radio-browser.info/json/stations/search?lat=${lat}&lon=${lng}&radius=${radii[i]}&limit=100&offset=${i*100}&hidebroken=true&order=clickcount&reverse=true`, { signal: abortController.signal });
                    const stations = await res.json();

                    stations.forEach(s => {
                        // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞: —Å–æ–∑–¥–∞–µ–º –≥–æ—Ä–æ–¥, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤ 30 –∫–º –ø—É—Å—Ç–æ
                        const isNew = !knownCities.some(c => getDistance(s.geo_lat, s.geo_long, c.lat, c.lng) < 30);
                        if (isNew) {
                            knownCities.push({
                                lat: s.geo_lat,
                                lng: s.geo_long,
                                name: s.state || s.country || "–ì–æ—Ä–æ–¥",
                                id: s.stationuuid
                            });
                        }
                    });

                    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –≥–æ—Ä–æ–¥–æ–≤
                    world.pointsData([...knownCities]);
                } catch (e) { if (e.name !== 'AbortError') console.error(e); }
            }
            status.style.display = 'none';
        }

        async function openCityStations(city) {
            const list = document.getElementById('stations-list');
            document.getElementById('side-drawer').classList.add('open');
            list.innerHTML = `<div class="city-title">${city.name}</div><div style="color:#666">–ó–∞–≥—Ä—É–∑–∫–∞...</div>`;

            try {
                // –§–∏–Ω–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ —Å—Ç—Ä–æ–≥–æ –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º –≥–æ—Ä–æ–¥–∞ (—Ä–∞–¥–∏—É—Å 30 –∫–º)
                const res = await fetch(`https://de1.api.radio-browser.info/json/stations/search?lat=${city.lat}&lon=${city.lng}&radius=30&limit=150&hidebroken=true&order=clickcount&reverse=true`);
                const stations = await res.json();
                
                list.innerHTML = `<div class="city-title">${city.name}</div>`;
                stations.forEach(s => {
                    const el = document.createElement('div');
                    el.className = 'station-card';
                    el.innerHTML = `<strong>${s.name}</strong><br><small style="color:#888">${s.tags || 'radio'}</small>`;
                    el.onclick = () => {
                        const player = document.getElementById('player-bar');
                        const audio = document.getElementById('audio-ctrl');
                        player.style.display = 'block';
                        document.getElementById('station-label').innerText = `üì° ${s.name}`;
                        audio.src = s.url_resolved.replace('http://', 'https://');
                        audio.play();
                    };
                    list.appendChild(el);
                });
            } catch (e) { list.innerHTML = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏"; }
        }

        function debounce(f, ms) { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => f.apply(this, a), ms); }; }
        world.onGlobeClick(() => document.getElementById('side-drawer').classList.remove('open'));

        // –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫
        setTimeout(runSearchCycle, 1000);
    </script>
</body>
</html>
