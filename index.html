<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<title>Radio Globe</title>
<style>
html, body {
    margin: 0;
    padding: 0;
    background: black;
    overflow: hidden;
    font-family: system-ui, sans-serif;
    color: white;
}

canvas {
    display: block;
}

#topBar {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    height: 40px;
    background: rgba(0,0,0,0.6);
    display: flex;
    align-items: center;
    padding: 0 10px;
    font-size: 14px;
    z-index: 10;
}

#geoBtn {
    margin-left: auto;
    cursor: pointer;
}

#bottomBar {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    height: 50px;
    background: rgba(0,0,0,0.6);
    display: flex;
    align-items: center;
    padding: 0 10px;
    gap: 10px;
    font-size: 12px;
}

#menu {
    position: fixed;
    top: 40px;
    bottom: 50px;
    left: -300px;
    width: 300px;
    background: rgba(0,0,0,0.85);
    transition: left 0.25s ease;
    z-index: 20;
    display: flex;
    flex-direction: column;
}

#menu.open {
    left: 0;
}

#menu input {
    margin: 10px;
    padding: 6px;
    background: #111;
    border: 1px solid #333;
    color: white;
}

#stations {
    flex: 1;
    overflow-y: auto;
}

.station {
    padding: 8px 10px;
    border-bottom: 1px solid #222;
    cursor: pointer;
}

.station:hover {
    background: #222;
}
</style>
</head>
<body>

<div id="topBar">
    <span id="cityLabel">‚Äî</span> /
    <span id="stationLabel">‚Äî</span>
    <span id="geoBtn">üìç</span>
</div>

<canvas id="globe"></canvas>

<div id="menu">
    <input id="citySearch" placeholder="–ü–æ–∏—Å–∫ –≥–æ—Ä–æ–¥–∞‚Ä¶" />
    <div id="stations"></div>
</div>

<div id="bottomBar">
    <input type="range" min="0" max="1" step="0.01" id="volume" />
    <span id="timer">00:00</span>
</div>

<audio id="audio"></audio>

<script>
/* ================== BASIC SETUP ================== */

const canvas = document.getElementById("globe");
const ctx = canvas.getContext("2d");

let w, h, cx, cy;
function resize() {
    w = canvas.width = window.innerWidth;
    h = canvas.height = window.innerHeight;
    cx = w / 2;
    cy = h / 2;
}
window.addEventListener("resize", resize);
resize();

/* ================== CAMERA ================== */

let rotX = 0;
let rotY = 0;
let zoom = 1.2;
const ZOOM_MIN = 0.8;
const ZOOM_MAX = 3.5;

/* ================== DATA ================== */

let cities = [];      // aggregated cities only
let visible = [];
let selectedCity = null;

/* ================== RADIO GARDEN API ================== */

const API = "https://radio.garden/api";

async function fetchStations(lat, lon) {
    const r = await fetch(`${API}/search?lat=${lat}&lon=${lon}`);
    return (await r.json()).hits || [];
}

/* ================== NORMALIZATION ================== */

function normalizeName(name) {
    return name
        .toLowerCase()
        .replace("moscow", "–º–æ—Å–∫–≤–∞")
        .replace("moskva", "–º–æ—Å–∫–≤–∞");
}

/* ================== GEO ================== */

function project(lat, lon) {
    const phi = lat * Math.PI / 180;
    const theta = lon * Math.PI / 180;

    let x = Math.cos(phi) * Math.sin(theta + rotX);
    let y = Math.sin(phi + rotY);
    let z = Math.cos(phi) * Math.cos(theta + rotX);

    if (z < 0) return null;

    return {
        x: cx + x * 250 * zoom,
        y: cy - y * 250 * zoom,
        z
    };
}

/* ================== CLUSTERING ================== */

function cluster(points) {
    const grid = {};
    const size = zoom < 1.5 ? 40 : zoom < 2.5 ? 25 : 15;

    for (const p of points) {
        const kx = Math.floor(p.x / size);
        const ky = Math.floor(p.y / size);
        const key = kx + "," + ky;
        if (!grid[key]) grid[key] = [];
        grid[key].push(p);
    }

    return Object.values(grid);
}

/* ================== RENDER ================== */

function draw() {
    ctx.clearRect(0,0,w,h);

    // night globe
    ctx.beginPath();
    ctx.arc(cx, cy, 260 * zoom, 0, Math.PI * 2);
    ctx.fillStyle = "#02040a";
    ctx.fill();

    visible = [];
    for (const c of cities) {
        const p = project(c.lat, c.lon);
        if (p) visible.push({...p, city: c});
    }

    const clusters = cluster(visible);

    for (const group of clusters) {
        const p = group[0];
        if (group.length === 1) {
            ctx.fillStyle = (selectedCity === p.city) ? "#ffb000" : "#00ff66";
            ctx.beginPath();
            ctx.arc(p.x, p.y, 4, 0, Math.PI * 2);
            ctx.fill();
        } else {
            ctx.fillStyle = "#3399ff";
            ctx.beginPath();
            ctx.arc(p.x, p.y, 7, 0, Math.PI * 2);
            ctx.fill();
        }
    }

    requestAnimationFrame(draw);
}
draw();

/* ================== INPUT ================== */

let dragging = false;
let px, py;

canvas.addEventListener("pointerdown", e => {
    dragging = true;
    px = e.clientX;
    py = e.clientY;
});

canvas.addEventListener("pointermove", e => {
    if (!dragging) return;
    rotX += (e.clientX - px) * 0.005;
    rotY += (e.clientY - py) * 0.005;
    px = e.clientX;
    py = e.clientY;
});

canvas.addEventListener("pointerup", () => dragging = false);

canvas.addEventListener("wheel", e => {
    zoom *= e.deltaY > 0 ? 0.9 : 1.1;
    zoom = Math.max(ZOOM_MIN, Math.min(ZOOM_MAX, zoom));
});

/* ================== CLICK ================== */

canvas.addEventListener("click", async e => {
    for (const p of visible) {
        const dx = e.clientX - p.x;
        const dy = e.clientY - p.y;
        if (dx*dx + dy*dy < 100) {
            selectCity(p.city);
            break;
        }
    }
});

/* ================== CITY SELECTION ================== */

async function selectCity(city) {
    selectedCity = city;
    document.getElementById("cityLabel").textContent = city.name;
    document.getElementById("menu").classList.add("open");

    const list = document.getElementById("stations");
    list.innerHTML = "–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶";

    const stations = await fetchStations(city.lat, city.lon);
    list.innerHTML = "";

    for (const s of stations) {
        const div = document.createElement("div");
        div.className = "station";
        div.textContent = s.name;
        div.onclick = () => playStation(s);
        list.appendChild(div);
    }
}

/* ================== AUDIO ================== */

const audio = document.getElementById("audio");
const volume = document.getElementById("volume");
volume.oninput = () => audio.volume = volume.value;

let startTime = 0;
setInterval(() => {
    if (!audio.paused) {
        const t = Math.floor((Date.now() - startTime) / 1000);
        document.getElementById("timer").textContent =
            String(Math.floor(t/60)).padStart(2,"0") + ":" +
            String(t%60).padStart(2,"0");
    }
}, 1000);

function playStation(s) {
    audio.src = s.stream;
    audio.play();
    startTime = Date.now();
    document.getElementById("stationLabel").textContent = s.name;
}

/* ================== GEOLOCATION ================== */

document.getElementById("geoBtn").onclick = () => {
    navigator.geolocation.getCurrentPosition(p => {
        const lat = p.coords.latitude;
        const lon = p.coords.longitude;
        const nearest = cities.reduce((a,b) =>
            dist(a,lat,lon) < dist(b,lat,lon) ? a : b
        );
        selectCity(nearest);
    });
};

function dist(c,lat,lon){
    return Math.hypot(c.lat-lat,c.lon-lon);
}

/* ================== INITIAL LOAD (SIMPLIFIED) ================== */
// –ó–¥–µ—Å—å –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ —Ç—ã –ø–æ–¥–≥—Ä—É–∂–∞–µ—à—å –≥–æ—Ä–æ–¥–∞
// –∏–∑ batch-–∑–∞–ø—Ä–æ—Å–æ–≤ Radio Garden –∏ –∞–≥—Ä–µ–≥–∏—Ä—É–µ—à—å –∏—Ö –∑–∞—Ä–∞–Ω–µ–µ

cities = [
    { name:"–ú–æ—Å–∫–≤–∞", lat:55.75, lon:37.61 },
    { name:"Berlin", lat:52.52, lon:13.40 },
    { name:"London", lat:51.50, lon:-0.12 }
];
</script>
</body>
</html>
