<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Radio Pro Max</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/globe.gl"></script>
    <style>
        /* –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –ì–ª–æ–±—É—Å –Ω–µ –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—Å—è, –µ—Å–ª–∏ —É body –∏ html –Ω–µ—Ç –≤—ã—Å–æ—Ç—ã */
        html, body { margin: 0; padding: 0; width: 100%; height: 100%; background: #000; overflow: hidden; font-family: sans-serif; }
        
        #globeViz { width: 100vw; height: 100vh; position: absolute; top: 0; left: 0; }

        /* –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å */
        #top-ui { position: fixed; top: 0; width: 100%; height: 60px; background: rgba(0,0,0,0.8); z-index: 100; border-bottom: 1px solid #333; display: flex; flex-direction: column; align-items: center; justify-content: center; pointer-events: none; }
        #city-display { font-size: 10px; color: #888; text-transform: uppercase; }
        #station-display { font-size: 14px; font-weight: bold; color: #00ff88; }

        #status-msg { position: fixed; top: 70px; left: 50%; transform: translateX(-50%); background: #00ff88; color: #000; padding: 4px 12px; border-radius: 20px; font-size: 10px; font-weight: bold; z-index: 99; display: none; }

        #geo-btn { position: fixed; top: 70px; right: 20px; z-index: 101; background: #222; border: 1px solid #444; border-radius: 50%; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 20px; color: white; }

        /* –ë–æ–∫–æ–≤–æ–µ –º–µ–Ω—é */
        #sidebar { position: fixed; top: 0; left: -320px; width: 300px; height: 100%; background: #0a0a0a; z-index: 200; transition: 0.3s; border-right: 1px solid #333; display: flex; flex-direction: column; color: white; }
        #sidebar.open { left: 0; }
        .sidebar-header { padding: 80px 20px 10px; }
        #city-search { width: 100%; padding: 12px; background: #1a1a1a; border: 1px solid #333; border-radius: 8px; color: white; outline: none; }

        #station-list { flex: 1; overflow-y: auto; padding: 10px; }
        .station-item { padding: 12px; margin-bottom: 8px; background: #161616; border-radius: 10px; cursor: pointer; font-size: 13px; border: 1px solid transparent; }
        .station-item:hover { border-color: #00ff88; }

        /* –ü–ª–µ–µ—Ä */
        #player-bar { position: fixed; bottom: 0; width: 100%; background: #111; padding: 15px; z-index: 150; border-top: 1px solid #333; display: none; box-sizing: border-box; color: white; }
        .player-content { display: flex; align-items: center; gap: 12px; max-width: 500px; margin: 0 auto; }
        input[type=range] { flex: 1; accent-color: #00ff88; }
    </style>
</head>
<body>

    <div id="top-ui">
        <div id="city-display">–í–†–ê–©–ê–ô–¢–ï –ì–õ–û–ë–£–°</div>
        <div id="station-display">RADIO PRO</div>
    </div>

    <div id="status-msg">–ü–û–ò–°–ö...</div>
    <div id="geo-btn" onclick="locate()">üìç</div>
    
    <div id="globeViz"></div>

    <div id="sidebar">
        <div class="sidebar-header">
            <input type="text" id="city-search" placeholder="–ü–æ–∏—Å–∫ —Å—Ç–∞–Ω—Ü–∏–∏..." oninput="filterStations()">
        </div>
        <div id="station-list"></div>
    </div>

    <div id="player-bar">
        <div class="player-content">
            <span>üîà</span>
            <input type="range" id="volume" min="0" max="1" step="0.01" value="0.8" oninput="setVol(this.value)">
            <div id="timer" style="font-family: monospace; font-size: 12px;">00:00</div>
        </div>
    </div>

    <audio id="audio"></audio>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready(); tg.expand();

        let allCities = []; // –•—Ä–∞–Ω–∏–º —Ç–æ–ª—å–∫–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –≥–æ—Ä–æ–¥–∞
        let currentStations = [];
        let selectedId = null;
        let abortCtrl = null;

        // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
        const world = Globe()(document.getElementById('globeViz'))
            .globeImageUrl('https://unpkg.com/three-globe/example/img/earth-night.jpg')
            .backgroundColor('#000000')
            .showAtmosphere(false)
            .pointsData([])
            .pointRadius(d => {
                const alt = world.pointOfView().alt;
                return (d.type === 'cluster' ? 1.2 : 0.6) * alt; // –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º —Ä–∞–∑–º–µ—Ä –ø–æ–¥ –∑—É–º
            })
            .pointColor(d => {
                if (d.id === selectedId) return '#ffa500'; // –û—Ä–∞–Ω–∂–µ–≤—ã–π –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ
                return d.type === 'cluster' ? '#007bff' : '#00ff88'; // –°–∏–Ω–∏–π –¥–ª—è –∫–ª–∞—Å—Ç–µ—Ä–∞, –∑–µ–ª–µ–Ω—ã–π –¥–ª—è –≥–æ—Ä–æ–¥–∞
            })
            .pointAltitude(0.01)
            .onPointClick(d => {
                if (d.type === 'cluster') {
                    const pov = world.pointOfView();
                    world.pointOfView({ lat: d.lat, lng: d.lng, alt: pov.alt * 0.4 }, 600);
                } else {
                    selectCity(d);
                }
            });

        const controls = world.controls();
        controls.minDistance = 105;
        controls.maxDistance = 600;

        // –ü–æ–∏—Å–∫ –ø—Ä–∏ –¥–≤–∏–∂–µ–Ω–∏–∏
        controls.addEventListener('change', debounce(() => {
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ—á–∫–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –º–∞—Å—à—Ç–∞–±–∞
            world.pointsData([...world.pointsData()]);
            searchCities();
        }, 500));

        // –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞ (–ì–∞–≤–µ—Ä—Å–∏–Ω—É—Å)
        function calcDist(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2-lat1)*Math.PI/180;
            const dLon = (lon2-lon1)*Math.PI/180;
            const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        async function searchCities() {
            const { lat, lng, alt } = world.pointOfView();
            if (abortCtrl) abortCtrl.abort();
            abortCtrl = new AbortController();

            const radius = Math.max(50, alt * 1000);
            document.getElementById('status-msg').style.display = 'block';

            try {
                // –ò—â–µ–º 1000 —Å—Ç–∞–Ω—Ü–∏–π –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –≥–æ—Ä–æ–¥–æ–≤
                const res = await fetch(`https://de1.api.radio-browser.info/json/stations/search?lat=${lat}&lon=${lng}&radius=${radius}&limit=1000&hidebroken=true&order=clickcount&reverse=true`, { signal: abortCtrl.signal });
                const data = await res.json();
                
                data.forEach(s => {
                    const sLat = parseFloat(s.geo_lat);
                    const sLng = parseFloat(s.geo_long);
                    if (!sLat || !sLng) return;

                    const name = (s.state || s.country || "Unknown").trim();
                    // –°–ª–∏—è–Ω–∏–µ: –µ—Å–ª–∏ –≥–æ—Ä–æ–¥ –≤ —Ä–∞–¥–∏—É—Å–µ 30 –∫–º, –Ω–µ –¥–æ–±–∞–≤–ª—è–µ–º
                    const exists = allCities.find(c => calcDist(sLat, sLng, c.lat, c.lng) < 30 || c.name.toLowerCase() === name.toLowerCase());

                    if (!exists) {
                        allCities.push({ id: s.stationuuid, lat: sLat, lng: sLng, name: name });
                    }
                });
                refreshPoints();
            } catch(e) {}
            document.getElementById('status-msg').style.display = 'none';
        }

        function refreshPoints() {
            const alt = world.pointOfView().alt;
            const threshold = alt * 12; // –ü–æ—Ä–æ–≥ –¥–ª—è –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è –≤ —Å–∏–Ω–∏–µ –∫—Ä—É–≥–∏
            const processed = new Set();
            const results = [];

            for (let i = 0; i < allCities.length; i++) {
                if (processed.has(i)) continue;
                let cluster = [allCities[i]];
                processed.add(i);

                for (let j = i + 1; j < allCities.length; j++) {
                    if (processed.has(j)) continue;
                    const d = Math.sqrt(Math.pow(allCities[i].lat - allCities[j].lat, 2) + Math.pow(allCities[i].lng - allCities[j].lng, 2));
                    if (d < threshold) {
                        cluster.push(allCities[j]);
                        processed.add(j);
                    }
                }

                if (cluster.length > 1) {
                    results.push({ ...cluster[0], type: 'cluster', id: 'cl-' + i });
                } else {
                    results.push({ ...allCities[i], type: 'city' });
                }
            }
            world.pointsData(results);
        }
