<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Radio Globe</title>

<style>
html, body {
  margin: 0;
  padding: 0;
  background: #000;
  color: #fff;
  overflow: hidden;
  font-family: system-ui, sans-serif;
}

/* Canvas */
#canvas {
  display: block;
}

/* Top bar */
#top {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 44px;
  background: rgba(0,0,0,0.6);
  display: flex;
  align-items: center;
  padding: 0 10px;
  gap: 10px;
  z-index: 10;
}
#title {
  flex: 1;
  font-size: 14px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
#geoBtn {
  cursor: pointer;
  font-size: 18px;
}

/* Bottom bar */
#bottom {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  height: 44px;
  background: rgba(0,0,0,0.6);
  display: flex;
  align-items: center;
  padding: 0 10px;
  gap: 10px;
  z-index: 10;
}
#time {
  font-size: 12px;
}
#volume {
  flex: 1;
}

/* Side panel */
#panel {
  position: absolute;
  top: 44px;
  bottom: 44px;
  left: 0;
  width: 280px;
  background: rgba(0,0,0,0.85);
  transform: translateX(-100%);
  transition: transform 0.25s ease;
  z-index: 20;
  display: flex;
  flex-direction: column;
}
#panel.open {
  transform: translateX(0);
}
#citySearch {
  padding: 8px;
  border: none;
  outline: none;
}
#stations {
  flex: 1;
  overflow-y: auto;
}
.station {
  padding: 8px;
  border-bottom: 1px solid #222;
  cursor: pointer;
}
.station:hover {
  background: #222;
}
</style>
</head>

<body>

<canvas id="canvas"></canvas>

<div id="top">
  <div id="title">–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥</div>
  <div id="geoBtn">üìç</div>
</div>

<div id="panel">
  <input id="citySearch" placeholder="–ü–æ–∏—Å–∫ –≥–æ—Ä–æ–¥–∞"/>
  <div id="stations"></div>
</div>

<div id="bottom">
  <div id="time">00:00</div>
  <input id="volume" type="range" min="0" max="1" step="0.01" value="0.8"/>
</div>

<audio id="audio"></audio>

<script>
/* =======================
   CONFIG
======================= */
const MIN_ZOOM = 0.8;
const MAX_ZOOM = 3.0;
const CITY_RADIUS_KM = 30;
const CLUSTER_PX = 22;

/* =======================
   STATE
======================= */
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
let w, h;

let zoom = 1.2;
let rotX = 0;
let rotY = 0;
let dragging = false;
let lastX = 0;
let lastY = 0;

let cities = []; // {id, name, lat, lon}
let selectedCity = null;
let clusters = [];

const audio = document.getElementById('audio');
let startTime = 0;

/* =======================
   UTILS
======================= */
function resize() {
  w = canvas.width = window.innerWidth;
  h = canvas.height = window.innerHeight;
}
window.addEventListener('resize', resize);
resize();

function normName(name) {
  return name.toLowerCase()
    .replace(/—ë/g,'–µ')
    .replace(/[^a-z–∞-—è0-9]/g,'');
}

function project(lat, lon) {
  const r = Math.min(w, h) * 0.4 * zoom;
  const phi = lat * Math.PI/180;
  const theta = lon * Math.PI/180 + rotX;

  const x3 = Math.cos(phi) * Math.sin(theta);
  const y3 = Math.sin(phi);
  const z3 = Math.cos(phi) * Math.cos(theta);

  if (z3 < 0) return null;

  return {
    x: w/2 + x3 * r,
    y: h/2 - y3 * r,
    z: z3
  };
}

/* =======================
   RADIO GARDEN API
======================= */
async function loadStations(offset = 0) {
  const res = await fetch(
    `https://radio.garden/api/ara/content/list?offset=${offset}`
  );
  const json = await res.json();
  return json.data.list;
}

async function loadCities() {
  let offset = 0;
  const map = new Map();

  while (offset < 3000) {
    const list = await loadStations(offset);
    for (const s of list) {
      if (!s.place) continue;
      const key = normName(s.place.name);
      if (!map.has(key)) {
        map.set(key, {
          id: key,
          name: s.place.name,
          lat: s.place.geo[1],
          lon: s.place.geo[0]
        });
      }
    }
    offset += list.length;
    if (list.length === 0) break;
  }

  cities = [...map.values()];
}

/* =======================
   CLUSTERING
======================= */
function buildClusters() {
  const grid = new Map();
  clusters = [];

  for (const c of cities) {
    const p = project(c.lat, c.lon);
    if (!p) continue;

    const gx = Math.floor(p.x / CLUSTER_PX);
    const gy = Math.floor(p.y / CLUSTER_PX);
    const key = gx + ':' + gy;

    if (!grid.has(key)) {
      grid.set(key, { x: p.x, y: p.y, list: [] });
    }
    grid.get(key).list.push(c);
  }

  for (const g of grid.values()) {
    clusters.push(g);
  }
}

/* =======================
   DRAW
======================= */
function draw() {
  ctx.clearRect(0,0,w,h);

  // globe
  ctx.strokeStyle = '#222';
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.arc(w/2, h/2, Math.min(w,h)*0.4*zoom, 0, Math.PI*2);
  ctx.stroke();

  buildClusters();

  for (const cl of clusters) {
    if (cl.list.length === 1) {
      ctx.fillStyle = 'lime';
      ctx.beginPath();
      ctx.arc(cl.x, cl.y, 4, 0, Math.PI*2);
      ctx.fill();
    } else {
      ctx.fillStyle = '#2aa';
      ctx.beginPath();
      ctx.arc(cl.x, cl.y, 6, 0, Math.PI*2);
      ctx.fill();
    }
  }

  requestAnimationFrame(draw);
}
draw();

/* =======================
   INTERACTION
======================= */
canvas.addEventListener('mousedown', e => {
  dragging = true;
  lastX = e.clientX;
  lastY = e.clientY;
});
window.addEventListener('mouseup', () => dragging = false);
window.addEventListener('mousemove', e => {
  if (!dragging) return;
  rotX += (e.clientX - lastX) * 0.005;
  rotY += (e.clientY - lastY) * 0.005;
  lastX = e.clientX;
  lastY = e.clientY;
});

canvas.addEventListener('wheel', e => {
  zoom *= e.deltaY > 0 ? 0.9 : 1.1;
  zoom = Math.min(MAX_ZOOM, Math.max(MIN_ZOOM, zoom));
});

canvas.addEventListener('click', e => {
  for (const cl of clusters) {
    const dx = e.clientX - cl.x;
    const dy = e.clientY - cl.y;
    const r = cl.list.length === 1 ? 6 : 8;
    if (dx*dx + dy*dy < r*r) {
      if (cl.list.length > 1) {
        zoom = Math.min(MAX_ZOOM, zoom * 1.4);
      } else {
        selectCity(cl.list[0]);
      }
      break;
    }
  }
});

/* =======================
   CITY & AUDIO
======================= */
async function selectCity(city) {
  selectedCity = city;
  document.getElementById('title').textContent = city.name;
  document.getElementById('panel').classList.add('open');

  const res = await fetch(
    `https://radio.garden/api/ara/content/page/${city.id}`
  );
  const json = await res.json();

  const list = json.data.content[0].items || [];
  const box = document.getElementById('stations');
  box.innerHTML = '';

  for (const s of list) {
    const div = document.createElement('div');
    div.className = 'station';
    div.textContent = s.title;
    div.onclick = () => playStation(s.stream);
    box.appendChild(div);
  }
}

function playStation(url) {
  audio.src = url;
  audio.play();
  startTime = Date.now();
}

audio.addEventListener('timeupdate', () => {
  const t = Math.floor(audio.currentTime);
  document.getElementById('time').textContent =
    String(Math.floor(t/60)).padStart(2,'0') + ':' +
    String(t%60).padStart(2,'0');
});
document.getElementById('volume').oninput =
  e => audio.volume = e.target.value;

/* =======================
   GEOLOCATION
======================= */
document.getElementById('geoBtn').onclick = () => {
  navigator.geolocation.getCurrentPosition(pos => {
    let best = null;
    let d0 = 1e9;
    for (const c of cities) {
      const dx = c.lat - pos.coords.latitude;
      const dy = c.lon - pos.coords.longitude;
      const d = dx*dx + dy*dy;
      if (d < d0) {
        d0 = d;
        best = c;
      }
    }
    if (best) selectCity(best);
  });
};

/* =======================
   INIT
======================= */
loadCities();
</script>

</body>
</html>
