<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Radio Pro: Multi-Step Search</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/globe.gl"></script>
    <style>
        body { margin: 0; background: #000; color: white; font-family: -apple-system, system-ui, sans-serif; overflow: hidden; }
        
        /* Индикатор поиска */
        #search-loader {
            position: fixed; top: 20px; right: 20px; z-index: 2000;
            background: rgba(0, 255, 136, 0.2); color: #00ff88;
            padding: 8px 15px; border-radius: 20px; font-size: 12px;
            border: 1px solid #00ff88; display: none; backdrop-filter: blur(5px);
        }

        #menu-btn { position: fixed; top: 20px; left: 20px; z-index: 1001; background: #222; border-radius: 50%; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; border: 1px solid #444; color: white; cursor: pointer; }
        
        #side-drawer {
            position: fixed; top: 0; left: -300px; width: 280px; height: 100%;
            background: #0d0d0d; z-index: 1002; transition: 0.3s ease; 
            display: flex; flex-direction: column; border-right: 1px solid #333;
        }
        #side-drawer.open { left: 0; }

        #stations-list { flex: 1; overflow-y: auto; padding: 15px; margin-top: 60px; }
        .city-header { font-size: 18px; color: #00ff88; font-weight: bold; margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .station-item { padding: 12px; border-radius: 8px; margin-bottom: 5px; background: #1a1a1a; cursor: pointer; font-size: 14px; }
        .station-item:active { background: #333; color: #ffa500; }

        #player {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; background: #111; padding: 15px; border-radius: 15px; border: 1px solid #333; display: none; z-index: 1003;
        }
    </style>
</head>
<body>

    <div id="search-loader">Сканирование горизонта...</div>
    <div id="menu-btn" onclick="document.getElementById('side-drawer').classList.toggle('open')">☰</div>
    
    <div id="globeViz"></div>

    <div id="side-drawer">
        <div id="stations-list"></div>
    </div>

    <div id="player">
        <div style="font-size: 12px; color: #888; margin-bottom: 8px;" id="current-name"></div>
        <audio id="audio-player" controls style="width: 100%; height: 30px;"></audio>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready(); tg.expand();

        let foundCities = new Map(); // Хранилище уникальных городов
        let currentSearchAbort = null; // Для отмены старых запросов

        const world = Globe()(document.getElementById('globeViz'))
            .globeImageUrl('//unpkg.com/three-globe/example/img/earth-night.jpg')
            .backgroundColor('#000000')
            .pointsData([])
            .pointRadius(0.8)
            .pointColor(() => '#00ff88')
            .pointAltitude(0.01)
            .onPointClick(d => loadCityDetails(d));

        const ctrl = world.controls();
        ctrl.minDistance = 150;
        ctrl.maxDistance = 600;

        // Следим за камерой
        ctrl.addEventListener('change', debounce(() => {
            startMultiStepSearch();
        }, 600));

        async function startMultiStepSearch() {
            const { lat, lng, alt } = world.pointOfView();
            const loader = document.getElementById('search-loader');
            
            // Отменяем предыдущий поиск если он шел
            if (currentSearchAbort) currentSearchAbort.abort();
            currentSearchAbort = new AbortController();

            loader.style.display = 'block';
            foundCities.clear();
            world.pointsData([]);

            // 5 итераций: от широкого радиуса к узкому
            // Радиусы: 2500km, 1000km, 500km, 200km, 50km
            const iterations = [2500, 1000, 500, 200, 50];
            
            for (let i = 0; i < iterations.length; i++) {
                if (currentSearchAbort.signal.aborted) break;
                
                const radius = iterations[i];
                const offset = i * 100; // Разные "страницы" для каждой итерации
                
                try {
                    const res = await fetch(
                        `https://de1.api.radio-browser.info/json/stations/search?lat=${lat}&lon=${lng}&radius=${radius}&limit=100&offset=${offset}&hidebroken=true&order=clickcount&reverse=true`,
                        { signal: currentSearchAbort.signal }
                    );
                    const stations = await res.json();
                    
                    processStations(stations);
                    
                    // Обновляем глобус после каждой итерации
                    world.pointsData(Array.from(foundCities.values()));
                    
                    loader.innerText = `Найдено городов: ${foundCities.size}...`;
                } catch (e) {
                    if (e.name !== 'AbortError') console.error(e);
                }
            }
            loader.style.display = 'none';
        }

        function processStations(stations) {
            stations.forEach(s => {
                const cityName = s.state || s.country || "Unknown";
                // Группируем, чтобы не плодить точки в одном месте
                const key = `${s.geo_lat.toFixed(1)}_${s.geo_long.toFixed(1)}`;
                
                if (!foundCities.has(key)) {
                    foundCities.set(key, {
                        lat: s.geo_lat,
                        lng: s.geo_long,
                        name: cityName,
                        id: s.stationuuid
                    });
                }
            });
        }

        async function loadCityDetails(city) {
            const drawer = document.getElementById('side-drawer');
            const list = document.getElementById('stations-list');
            
            drawer.classList.add('open');
            list.innerHTML = `<div class="city-header">${city.name}</div><div style="color:#888">Загрузка станций...</div>`;

            try {
                // Финальный точный запрос для города
                const res = await fetch(`https://de1.api.radio-browser.info/json/stations/search?lat=${city.lat}&lon=${city.lng}&radius=30&limit=100&hidebroken=true&order=clickcount&reverse=true`);
                const data = await res.json();
                
                list.innerHTML = `<div class="city-header">${city.name}</div>`;
                data.forEach(s => {
                    const div = document.createElement('div');
                    div.className = 'station-item';
                    div.innerText = s.name;
                    div.onclick = () => {
                        const player = document.getElementById('player');
                        const audio = document.getElementById('audio-player');
                        player.style.display = 'block';
                        document.getElementById('current-name').innerText = s.name;
                        audio.src = s.url_resolved.replace('http://', 'https://');
                        audio.play();
                    };
                    list.appendChild(div);
                });
            } catch (e) { list.innerHTML = "Ошибка загрузки"; }
        }

        function debounce(f, ms) {
            let t; return (...a) => { clearTimeout(t); t = setTimeout(() => f.apply(this, a), ms); };
        }

        world.onGlobeClick(() => document.getElementById('side-drawer').classList.remove('open'));
        
        // Стартовый запуск
        setTimeout(startMultiStepSearch, 1000);
    </script>
</body>
</html>
