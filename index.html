// 1. ХРАНИЛИЩЕ ДАННЫХ
let regionCache = []; // Крупные точки (страны/регионы)
let cityCache = new Map(); // Кэш городов: { "lat_lng": { cityData } }
let activeCityId = null;

// 2. ИНИЦИАЛИЗАЦИЯ ГЛОБУСА
const world = Globe()(document.getElementById('globeViz'))
    .pointsData([])
    .pointRadius(d => d.type === 'cluster' ? 2.0 : 0.8)
    .pointColor(d => {
        if (d.id === activeCityId) return '#ffa500'; // Выбранный город
        return d.type === 'cluster' ? '#007bff' : '#00ff88'; // Кластер vs Город
    })
    .onPointClick(d => {
        if (d.type === 'cluster') {
            // При клике на регион — приближаем камеру для уточнения городов
            world.pointOfView({ lat: d.lat, lng: d.lng, alt: 0.7 }, 800);
        } else {
            // При клике на город — загружаем станции
            loadStationsForCity(d);
        }
    });

// 3. ПЕРВОНАЧАЛЬНАЯ ЗАГРУЗКА (УРОВЕНЬ 1)
// Запрашиваем топ-500 станций мира, чтобы просто пометить "живые" зоны
fetch('https://de1.api.radio-browser.info/json/stations/search?limit=500&has_geo_info=true&hidebroken=true&order=clickcount&reverse=true')
    .then(r => r.json())
    .then(data => {
        // Группируем их по странам для начального отображения
        const clusters = new Map();
        data.forEach(s => {
            const key = s.countrycode;
            if (!clusters.has(key)) {
                clusters.set(key, { lat: s.geo_lat, lng: s.geo_long, type: 'cluster', id: key });
            }
        });
        regionCache = Array.from(clusters.values());
        world.pointsData(regionCache);
    });

// 4. ДИНАМИЧЕСКОЕ УТОЧНЕНИЕ (УРОВЕНЬ 2)
// Следим за камерой: если мы близко, подгружаем реальные города
world.controls().addEventListener('change', debounce(() => {
    const { alt, lat, lng } = world.pointOfView();
    
    if (alt < 1.0) {
        // Запрашиваем города в текущем радиусе видимости
        fetchCitiesInArea(lat, lng, alt * 500); 
    } else {
        // Возвращаемся к глобальным кластерам
        world.pointsData(regionCache);
    }
}, 300));

async function fetchCitiesInArea(lat, lng, radius) {
    // search по координатам и радиусу, но с лимитом, чтобы не тянуть лишнее
    const url = `https://de1.api.radio-browser.info/json/stations/search?lat=${lat}&lon=${lng}&radius=${radius}&limit=200&hidebroken=true`;
    const res = await fetch(url);
    const data = await res.json();
    
    const cities = new Map();
    data.forEach(s => {
        const key = `${s.geo_lat.toFixed(1)}_${s.geo_long.toFixed(1)}`;
        if (!cities.has(key)) {
            cities.set(key, {
                id: s.stationuuid,
                lat: s.geo_lat,
                lng: s.geo_long,
                city: s.state || s.country || 'Unknown',
                type: 'city'
            });
        }
    });
    world.pointsData(Array.from(cities.values()));
}

// 5. ПОДГРУЗКА ВСЕХ СТАНЦИЙ (УРОВЕНЬ 3)
async function loadStationsForCity(city) {
    activeCityId = city.id;
    document.getElementById('side-drawer').classList.add('open');
    const list = document.getElementById('stations-list');
    list.innerHTML = 'Загрузка всех станций...';

    // Запрос всех станций конкретно в этой точке (малый радиус)
    const res = await fetch(`https://de1.api.radio-browser.info/json/stations/search?lat=${city.lat}&lon=${city.lng}&radius=20&hidebroken=true&order=clickcount&reverse=true`);
    const stations = await res.json();
    
    list.innerHTML = `<div class="list-header">${city.city}</div>`;
    stations.forEach(s => {
        const item = document.createElement('div');
        item.className = 'station-item';
        item.innerText = s.name;
        item.onclick = () => play(s, city.city);
        list.appendChild(item);
    });
}
