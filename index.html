<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Radio Pro Cluster Fix</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/globe.gl"></script>
    <style>
        body { margin: 0; background: #000; color: white; font-family: -apple-system, sans-serif; overflow: hidden; }
        #globeViz { width: 100vw; height: 100vh; }
        
        /* Стили маркеров */
        .dot { border-radius: 50%; cursor: pointer; transform: translate(-50%, -50%); pointer-events: auto; }
        .dot-city { width: 10px; height: 10px; background: #00ff88; box-shadow: 0 0 10px #00ff88; border: 1px solid #fff; }
        .dot-cluster { 
            width: 26px; height: 26px; background: #007bff; border: 2px solid #fff;
            display: flex; align-items: center; justify-content: center; 
            font-size: 11px; font-weight: bold; color: white; box-shadow: 0 0 15px #007bff;
        }
        .dot-active { background: #ffa500 !important; box-shadow: 0 0 20px #ffa500; width: 14px; height: 14px; }

        #scanner-info { position: fixed; top: 15px; right: 15px; background: rgba(0,255,136,0.2); color: #00ff88; padding: 5px 12px; border-radius: 15px; font-size: 10px; z-index: 1001; }
        #menu-btn { position: fixed; top: 65px; left: 15px; z-index: 1001; background: #222; border-radius: 50%; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 1px solid #444; }
        #side-drawer { position: fixed; top: 0; left: -320px; width: 280px; height: 100%; background: #0d0d0d; z-index: 1002; transition: 0.3s; border-right: 1px solid #333; overflow-y: auto; padding-top: 60px; }
        #side-drawer.open { left: 0; }
        .city-group { margin: 10px; background: #1a1a1a; padding: 10px; border-radius: 8px; cursor: pointer; }
        .station-item { padding: 8px; font-size: 12px; border-top: 1px solid #333; color: #ccc; }
    </style>
</head>
<body>

    <div id="scanner-info">ЗАГРУЗКА...</div>
    <div id="menu-btn">☰</div>
    <div id="globeViz"></div>
    <div id="side-drawer" class="drawer-header">
        <div id="stations-list"></div>
    </div>

    <script>
        const world = Globe()(document.getElementById('globeViz'))
            .globeImageUrl('https://unpkg.com/three-globe/example/img/earth-night.jpg')
            .backgroundColor('#000000')
            .showAtmosphere(true)
            .atmosphereColor('#00ff88')
            .atmosphereDaylightAlpha(0.1)
            .htmlElementsData([])
            .htmlElement(d => {
                const el = document.createElement('div');
                if (d.isCluster) {
                    el.className = 'dot dot-cluster';
                    el.innerHTML = d.count;
                    el.onclick = (e) => {
                        e.stopPropagation();
                        world.pointOfView({ lat: d.lat, lng: d.lng, alt: world.pointOfView().alt / 2 }, 600);
                    };
                } else {
                    el.className = 'dot dot-city';
                    const key = (d.city + d.lat).toLowerCase();
                    if (window.activeKey === key) el.classList.add('dot-active');
                    el.onclick = () => openCity(d);
                }
                return el;
            });

        let allCities = [];
        let offset = 0;

        // КЛАСТЕРИЗАЦИЯ
        function updateClusters() {
            if (allCities.length === 0) return;

            const DIST = 40; // Пикселей для объединения
            const clusters = [];
            const processed = new Set();

            // 1. Получаем экранные позиции
            const points = allCities.map((c, idx) => {
                const coords = world.getCoords(c.lat, c.lng);
                const pos = world.getScreenCoords(coords.x, coords.y, coords.z);
                return { ...c, sx: pos.x, sy: pos.y, id: idx };
            });

            // 2. Группируем
            for (let i = 0; i < points.length; i++) {
                if (processed.has(i)) continue;

                let cluster = [points[i]];
                processed.add(i);

                for (let j = i + 1; j < points.length; j++) {
                    if (processed.has(j)) continue;

                    const dx = points[i].sx - points[j].sx;
                    const dy = points[i].sy - points[j].sy;
                    const d = Math.sqrt(dx*dx + dy*dy);

                    if (d < DIST) {
                        cluster.push(points[j]);
                        processed.add(j);
                    }
                }

                if (cluster.length > 1) {
                    clusters.push({
                        lat: cluster[0].lat,
                        lng: cluster[0].lng,
                        count: cluster.length,
                        isCluster: true
                    });
                } else {
                    clusters.push({ ...cluster[0], isCluster: false });
                }
            }

            world.htmlElementsData(clusters);
        }

        // СКАНЕР
        async function loadData() {
            try {
                const res = await fetch(`https://de1.api.radio-browser.info/json/stations/search?limit=100&offset=${offset}&has_geo_info=true&hidebroken=true`);
                const data = await res.json();
                
                data.forEach(s => {
                    const lat = parseFloat(s.geo_lat), lng = parseFloat(s.geo_long);
                    const city = s.state || s.country || 'Unknown';
                    let exist = allCities.find(c => Math.abs(c.lat - lat) < 0.1);
                    if (exist) {
                        exist.stations.push(s);
                    } else {
                        allCities.push({ lat, lng, city, stations: [s] });
                    }
                });

                document.getElementById('scanner-info').innerText = `ГОРОДОВ: ${allCities.length}`;
                updateClusters();
                offset += 100;
            } catch (e) {}
        }

        function openCity(d) {
            window.activeKey = (d.city + d.lat).toLowerCase();
            world.pointOfView({ lat: d.lat, lng: d.lng, alt: 1.2 }, 600);
            
            const list = document.getElementById('stations-list');
            list.innerHTML = `<div class="city-group"><b>${d.city}</b></div>`;
            d.stations.forEach(s => {
                const item = document.createElement('div');
                item.className = 'station-item';
                item.innerText = s.name;
                list.appendChild(item);
            });
            document.getElementById('side-drawer').classList.add('open');
            updateClusters();
        }

        // Обработчики
        world.controls().addEventListener('end', updateClusters); // Обновляем в конце движения
        document.getElementById('menu-btn').onclick = () => document.getElementById('side-drawer').classList.toggle('open');
        
        // Старт
        loadData();
        setInterval(loadData, 5000);
        
        // Первый принудительный рендер через секунду (пока камера встает)
        setTimeout(updateClusters, 1000);
    </script>
</body>
</html>
