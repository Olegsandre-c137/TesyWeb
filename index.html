<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Radio Pro Max</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/globe.gl"></script>
    <style>
        body { margin: 0; background: #000; color: white; font-family: -apple-system, sans-serif; overflow: hidden; }
        
        /* Header */
        #top-bar { position: fixed; top: 0; width: 100%; height: 65px; background: rgba(0,0,0,0.8); z-index: 100; border-bottom: 1px solid #333; display: flex; flex-direction: column; align-items: center; justify-content: center; pointer-events: none; }
        #city-name { font-size: 11px; color: #888; text-transform: uppercase; letter-spacing: 1px; }
        #station-name { font-size: 15px; font-weight: bold; color: #00ff88; margin-top: 2px; }

        /* UI Buttons */
        #geo-btn { position: fixed; top: 80px; right: 20px; z-index: 100; background: #222; border: 1px solid #444; border-radius: 50%; width: 46px; height: 46px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }

        /* Sidebar */
        #sidebar { position: fixed; top: 0; left: -320px; width: 300px; height: 100%; background: #0a0a0a; z-index: 200; transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1); border-right: 1px solid #333; display: flex; flex-direction: column; }
        #sidebar.open { left: 0; }
        .sidebar-header { padding: 80px 20px 15px; background: #0f0f0f; }
        #search-input { width: 100%; padding: 12px; background: #1a1a1a; border: 1px solid #333; border-radius: 8px; color: white; outline: none; }
        #search-input:focus { border-color: #00ff88; }
        #station-list { flex: 1; overflow-y: auto; padding: 10px; }
        .station-item { padding: 14px; margin-bottom: 8px; background: #161616; border-radius: 10px; cursor: pointer; font-size: 14px; border: 1px solid transparent; transition: 0.2s; }
        .station-item:hover { background: #222; border-color: #00ff88; }

        /* Player Footer */
        #player-bar { position: fixed; bottom: 0; width: 100%; background: rgba(10,10,10,0.95); padding: 18px; z-index: 150; border-top: 1px solid #333; display: none; backdrop-filter: blur(10px); }
        .player-content { display: flex; align-items: center; gap: 15px; max-width: 600px; margin: 0 auto; }
        #volume-slider { flex: 1; accent-color: #00ff88; cursor: pointer; }
        #time-counter { font-family: monospace; font-size: 13px; color: #00ff88; min-width: 45px; }

        /* Markers Styles */
        .dot { width: 10px; height: 10px; border-radius: 50%; background: #00ff88; cursor: pointer; transform: translate(-50%, -50%); border: 1px solid #000; transition: 0.3s; }
        .dot.cluster { width: 18px; height: 18px; background: #007bff; border: 2px solid white; box-shadow: 0 0 10px rgba(0,123,255,0.5); }
        .dot.active { background: #ffcc00; box-shadow: 0 0 15px #ffcc00; width: 12px; height: 12px; border: 2px solid white; }
    </style>
</head>
<body>

    <div id="top-bar">
        <div id="city-name">–í–´–ë–ï–†–ò–¢–ï –ì–û–†–û–î</div>
        <div id="station-name">RADIO WORLD</div>
    </div>

    <div id="geo-btn" onclick="locateMe()">üìç</div>

    <div id="globeViz"></div>

    <div id="sidebar">
        <div class="sidebar-header">
            <input type="text" id="search-input" placeholder="–ü–æ–∏—Å–∫ –≤ —ç—Ç–æ–º –≥–æ—Ä–æ–¥–µ..." oninput="filterStations()">
        </div>
        <div id="station-list"></div>
    </div>

    <div id="player-bar">
        <div class="player-content">
            <span style="font-size: 18px;">üîà</span>
            <input type="range" id="volume-slider" min="0" max="1" step="0.01" value="0.8">
            <div id="time-counter">00:00</div>
        </div>
    </div>

    <audio id="audio-engine"></audio>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready(); tg.expand();

        let allCities = []; // –ì–ª–æ–±–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –≥–æ—Ä–æ–¥–æ–≤ {id, lat, lng, name}
        let currentStations = []; // –°—Ç–∞–Ω—Ü–∏–∏ —Ç–µ–∫—É—â–µ–≥–æ –≥–æ—Ä–æ–¥–∞
        let selectedCityId = null;
        let searchTimeout = null;

        const world = Globe()(document.getElementById('globeViz'))
            .globeImageUrl('//unpkg.com/three-globe/example/img/earth-night.jpg')
            .backgroundColor('#000000')
            .showAtmosphere(false)
            .htmlElementsData([])
            .htmlElement(d => {
                const el = document.createElement('div');
                el.className = `dot ${d.type === 'cluster' ? 'cluster' : ''} ${d.id === selectedCityId ? 'active' : ''}`;
                el.onclick = () => d.type === 'cluster' ? handleClusterClick(d) : handleCityClick(d);
                return el;
            });

        const controls = world.controls();
        controls.minDistance = 105;
        controls.maxDistance = 600;

        // –°–ª–µ–¥–∏–º –∑–∞ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ–º
        controls.addEventListener('change', () => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(fetchCities, 800);
        });

        // –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2-lat1)*Math.PI/180;
            const dLon = (lon2-lon1)*Math.PI/180;
            const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        async function fetchCities() {
            const { lat, lng, alt } = world.pointOfView();
            // –ü—Ä–∏–º–µ—Ä–Ω—ã–π —Ä–∞–¥–∏—É—Å –≤–∏–¥–∏–º–æ–π –æ–±–ª–∞—Å—Ç–∏
            const viewRadius = alt * 1200; 

            try {
                // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º 1000 —Å—Ç–∞–Ω—Ü–∏–π –≤ –≤–∏–¥–∏–º–æ–π –æ–±–ª–∞—Å—Ç–∏
                const res = await fetch(`https://de1.api.radio-browser.info/json/stations/search?lat=${lat}&lon=${lng}&radius=${viewRadius}&limit=1000&hidebroken=true&order=clickcount&reverse=true`);
                const data = await res.json();
                
                data.forEach(s => {
                    const sLat = parseFloat(s.geo_lat);
                    const sLng = parseFloat(s.geo_long);
                    if (!sLat || !sLng) return;

                    const cityName = (s.state || s.country || "Unknown").trim();
                    
                    // –ü—Ä–∞–≤–∏–ª–æ 30–∫–º: –∏—â–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –≥–æ—Ä–æ–¥ —Ä—è–¥–æ–º
                    const existing = allCities.find(c => 
                        getDistance(sLat, sLng, c.lat, c.lng) < 30 || 
                        c.name.toLowerCase() === cityName.toLowerCase()
                    );

                    if (!existing) {
                        allCities.push({ id: s.stationuuid, lat: sLat, lng: sLng, name: cityName });
                    }
                });
                renderMarkers();
            } catch (e) { console.error("Search failed", e); }
        }

        function renderMarkers() {
            const alt = world.pointOfView().alt;
            const clusterRadius = alt * 8; // –ü–æ—Ä–æ–≥ —Å—Ö–ª–æ–ø—ã–≤–∞–Ω–∏—è –≤ —Å–∏–Ω–∏–π –∫—Ä—É–≥
            const displayed = [];
            const visited = new Set();

            for (let i = 0; i < allCities.length; i++) {
                if (visited.has(i)) continue;
                let cluster = [allCities[i]];
                visited.add(i);

                for (let j = i + 1; j < allCities.length; j++) {
                    if (visited.has(j)) continue;
                    const d = Math.sqrt((allCities[i].lat - allCities[j].lat)**2 + (allCities[i].lng - allCities[j].lng)**2);
                    if (d < clusterRadius) {
                        cluster.push(allCities[j]);
                        visited.add(j);
                    }
                }

                if (cluster.length > 1) {
                    displayed.push({ ...cluster[0], type: 'cluster', id: 'cl-' + i });
                } else {
                    displayed.push({ ...allCities[i], type: 'city' });
                }
            }
            world.htmlElementsData(displayed);
        }

        function handleClusterClick(d) {
            const pov = world.pointOfView();
            world.pointOfView({ lat: d.lat, lng: d.lng, alt: pov.alt * 0.4 }, 800);
        }

        async function handleCityClick(city) {
            selectedCityId = city.id;
            renderMarkers(); // –ß—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏—Ç—å —Ü–≤–µ—Ç –Ω–∞ –∂–µ–ª—Ç—ã–π
            
            document.getElementById('city-name').innerText = city.name;
            document.getElementById('sidebar').classList.add('open');
            const list = document.getElementById('station-list');
            list.innerHTML = '<div style="padding:20px; color:#555">–ò—â–µ–º —Å—Ç–∞–Ω—Ü–∏–∏...</div>';

            try {
                // –ü–æ–∏—Å–∫ —Å—Ç–∞–Ω—Ü–∏–π –¢–û–õ–¨–ö–û –≤ —ç—Ç–æ–º –≥–æ—Ä–æ–¥–µ
                const res = await fetch(`https://de1.api.radio-browser.info/json/stations/search?lat=${city.lat}&lon=${city.lng}&radius=30&limit=150&hidebroken=true&order=clickcount&reverse=true`);
                currentStations = await res.json();
                renderStationList(currentStations);
            } catch (e) { list.innerHTML = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏"; }
        }

        function renderStationList(data) {
            const list = document.getElementById('station-list');
            list.innerHTML = '';
            data.forEach(s => {
                const item = document.createElement('div');
                item.className = 'station-item';
                item.innerHTML = `<div>${s.name}</div><div style="font-size:10px; color:#555; margin-top:4px">${s.bitrate ? s.bitrate+'kbps' : ''} ${s.tags ? '‚Ä¢ '+s.tags.split(',')[0] : ''}</div>`;
                item.onclick = () => playStream(s);
                list.appendChild(item);
            });
        }

        function playStream(s) {
            const audio = document.getElementById('audio-engine');
            document.getElementById('station-name').innerText = s.name;
            document.getElementById('player-bar').style.display = 'block';
            
            audio.src = s.url_resolved.replace('http://', 'https://');
            audio.play().catch(() => tg.showAlert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ—Ç–æ–∫"));
            
            if (window.innerWidth < 600) document.getElementById('sidebar').classList.remove('open');
        }

        function filterStations() {
            const query = document.getElementById('search-input').value.toLowerCase();
            const filtered = currentStations.filter(s => s.name.toLowerCase().includes(query));
            renderStationList(filtered);
        }

        function locateMe() {
            navigator.geolocation.getCurrentPosition(p => {
                world.pointOfView({ lat: p.coords.latitude, lng: p.coords.longitude, alt: 0.8 }, 1200);
                setTimeout(fetchCities, 1300);
            }, () => tg.showAlert("–î–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ø–æ–∑–∏—Ü–∏–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω"));
        }

        // –ü–ª–µ–µ—Ä
        const audio = document.getElementById('audio-engine');
        audio.ontimeupdate = () => {
            const m = Math.floor(audio.currentTime / 60);
            const s = Math.floor(audio.currentTime % 60);
            document.getElementById('time-counter').innerText = `${m}:${s < 10 ? '0' : ''}${s}`;
        };
        document.getElementById('volume-slider').oninput = (e) => audio.volume = e.target.value;

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –Ω–∞ –≥–ª–æ–±—É—Å
        world.onGlobeClick(() => document.getElementById('sidebar').classList.remove('open'));

        // –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫
        setTimeout(fetchCities, 1000);
    </script>
</body>
</html>
