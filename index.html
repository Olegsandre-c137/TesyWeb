<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Radio Pro Max: Spatial</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/globe.gl"></script>
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: -apple-system, system-ui, sans-serif; }
        
        #radar-ui {
            position: fixed; top: 15px; right: 15px; z-index: 1000;
            background: rgba(0, 0, 0, 0.7); color: #00ff88;
            padding: 8px 15px; border-radius: 20px; font-size: 11px;
            border: 1px solid #00ff88; backdrop-filter: blur(10px); display: none;
        }

        #side-drawer {
            position: fixed; top: 0; left: -320px; width: 300px; height: 100%;
            background: rgba(10, 10, 10, 0.98); z-index: 1002; transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex; flex-direction: column; border-right: 1px solid #333; color: white;
        }
        #side-drawer.open { left: 0; }

        #stations-list { flex: 1; overflow-y: auto; padding: 20px; margin-top: 50px; }
        .city-title { font-size: 20px; color: #00ff88; margin-bottom: 20px; font-weight: 800; border-bottom: 2px solid #00ff88; padding-bottom: 10px; }
        .station-item { 
            padding: 14px; background: #1a1a1a; border-radius: 12px; 
            margin-bottom: 10px; cursor: pointer; border: 1px solid #333; transition: 0.2s;
        }
        .station-item:active { background: #00ff88; color: #000; }

        #player {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 85%; background: #111; padding: 15px; border-radius: 20px;
            display: none; z-index: 1003; border: 1px solid #444; color: white;
        }
    </style>
</head>
<body>

    <div id="radar-ui">–°–ö–ê–ù–ï–†: <span id="city-count">0</span> –ì–û–†.</div>
    <div id="globeViz"></div>

    <div id="side-drawer">
        <div id="stations-list"></div>
    </div>

    <div id="player">
        <div id="playing-name" style="font-size: 12px; margin-bottom: 10px; color: #00ff88; font-weight: bold;"></div>
        <audio id="audio" controls style="width: 100%; height: 35px;"></audio>
    </div>

    <script src="https://unpkg.com/three"></script>
    <script>
        const tg = window.Telegram.WebApp;
        tg.ready(); tg.expand();

        let knownCities = [];
        let searchAbort = null;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥–ª–æ–±—É—Å–∞
        const world = Globe()(document.getElementById('globeViz'))
            .globeImageUrl('//unpkg.com/three-globe/example/img/earth-night.jpg')
            .backgroundColor('#000000')
            .showAtmosphere(true)
            .atmosphereColor('#00ff88')
            .atmosphereDayLightTime(1400)
            // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Custom Layer –¥–ª—è —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ä–∞–∑–º–µ—Ä–æ–≤ –∫—Ä—É–≥–æ–≤
            .customLayerData([])
            .customThreeObject(d => {
                const spriteMaterial = new THREE.SpriteMaterial({ 
                    color: 0x00ff88,
                    map: new THREE.CanvasTexture(generateCircleCanvas())
                });
                const sprite = new THREE.Sprite(spriteMaterial);
                sprite.scale.set(12, 12, 1.0); // –†–∞–∑–º–µ—Ä –∫—Ä—É–≥–∞ –Ω–∞ —ç–∫—Ä–∞–Ω–µ (–≤—Å–µ–≥–¥–∞ –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π)
                return sprite;
            })
            .customThreeObjectUpdate((obj, d) => {
                Object.assign(obj.position, world.getCoords(d.lat, d.lng, 0.01));
            });

        // –§—É–Ω–∫—Ü–∏—è —Ä–∏—Å–æ–≤–∞–Ω–∏—è –º—è–≥–∫–æ–≥–æ –∫—Ä—É–≥–∞ –¥–ª—è —Å–ø—Ä–∞–π—Ç–∞
        function generateCircleCanvas() {
            const canvas = document.createElement('canvas');
            canvas.width = 64; canvas.height = 64;
            const ctx = canvas.getContext('2d');
            ctx.beginPath();
            ctx.arc(32, 32, 28, 0, 2 * Math.PI);
            ctx.fillStyle = 'white';
            ctx.fill();
            return canvas;
        }

        const controls = world.controls();
        controls.minDistance = 105; 
        controls.maxDistance = 700;
        controls.enableDamping = true;

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ –ø–æ –∫–∞—Å—Ç–æ–º–Ω–æ–º—É –æ–±—ä–µ–∫—Ç—É
        world.onCustomLayerClick(d => fetchCityFinal(d));

        controls.addEventListener('change', debounce(() => startRadar(), 700));

        // –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è (–ì–∞–≤–µ—Ä—Å–∏–Ω—É—Å)
        function calcDist(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2-lat1)*Math.PI/180;
            const dLon = (lon2-lon1)*Math.PI/180;
            const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        async function startRadar() {
            const { lat, lng } = world.pointOfView();
            const ui = document.getElementById('radar-ui');
            
            if (searchAbort) searchAbort.abort();
            searchAbort = new AbortController();

            ui.style.display = 'block';
            
            // 4 –∏—Ç–µ—Ä–∞—Ü–∏–∏ –∫–∞—Å–∫–∞–¥–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞
            const steps = [2200, 900, 350, 80];
            
            for (let i = 0; i < steps.length; i++) {
                if (searchAbort.signal.aborted) break;
                const radius = steps[i];
                
                try {
                    const res = await fetch(`https://de1.api.radio-browser.info/json/stations/search?lat=${lat}&lon=${lng}&radius=${radius}&limit=100&offset=${i*100}&hidebroken=true&order=clickcount&reverse=true`, { signal: searchAbort.signal });
                    const stations = await res.json();

                    stations.forEach(s => {
                        // –ü—Ä–∞–≤–∏–ª–æ 30 –∫–º: –≥–æ—Ä–æ–¥ —Å–æ–∑–¥–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤ —Ä–∞–¥–∏—É—Å–µ –Ω–µ—Ç –¥—Ä—É–≥–∏—Ö
                        const exists = knownCities.some(c => calcDist(s.geo_lat, s.geo_long, c.lat, c.lng) < 30);
                        if (!exists) {
                            knownCities.push({
                                lat: s.geo_lat,
                                lng: s.geo_long,
                                name: s.state || s.country || "–ì–æ—Ä–æ–¥",
                                id: s.stationuuid
                            });
                        }
                    });

                    world.customLayerData([...knownCities]);
                    document.getElementById('city-count').innerText = knownCities.length;
                    
                } catch (e) { if (e.name !== 'AbortError') console.error(e); }
            }
            ui.style.display = 'none';
        }

        async function fetchCityFinal(city) {
            const list = document.getElementById('stations-list');
            document.getElementById('side-drawer').classList.add('open');
            list.innerHTML = `<div class="city-title">${city.name}</div><div style="color: #666">–ê–Ω–∞–ª–∏–∑ —á–∞—Å—Ç–æ—Ç –≥–æ—Ä–æ–¥–∞...</div>`;

            try {
                // –ü–æ–∏—Å–∫ –ø–æ —Ä–∞–¥–∏—É—Å—É –≥–æ—Ä–æ–¥–∞ (30 –∫–º —Å—á–∏—Ç–∞–µ—Ç—Å—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–º –≥–æ—Ä–æ–¥—Å–∫–∏–º —Ä–∞–¥–∏—É—Å–æ–º)
                const res = await fetch(`https://de1.api.radio-browser.info/json/stations/search?lat=${city.lat}&lon=${city.lng}&radius=35&limit=200&hidebroken=true&order=clickcount&reverse=true`);
                const stations = await res.json();
                
                list.innerHTML = `<div class="city-title">${city.name}</div>`;
                if(stations.length === 0) list.innerHTML += '<div>–°—Ç–∞–Ω—Ü–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';

                stations.forEach(s => {
                    const div = document.createElement('div');
                    div.className = 'station-item';
                    div.innerHTML = `<strong>${s.name}</strong><br><small style="opacity:0.6">${s.tags.split(',').slice(0,2).join(' ‚Ä¢ ') || 'music'}</small>`;
                    div.onclick = () => {
                        const p = document.getElementById('player');
                        const a = document.getElementById('audio');
                        p.style.display = 'block';
                        document.getElementById('playing-name').innerText = `üì° ${s.name}`;
                        a.src = s.url_resolved.replace('http://', 'https://');
                        a.play();
                    };
                    list.appendChild(div);
                });
            } catch (e) { list.innerHTML = "–û—à–∏–±–∫–∞ —Å–µ—Ç–∏"; }
        }

        function debounce(f, ms) { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => f.apply(this, a), ms); }; }
        world.onGlobeClick(() => document.getElementById('side-drawer').classList.remove('open'));

        // –ê–≤—Ç–æ-—Å—Ç–∞—Ä—Ç
        setTimeout(startRadar, 800);
    </script>
</body>
</html>
