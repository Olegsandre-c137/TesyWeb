<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Radio Pro Max: WebGL</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/three"></script>
    <script src="https://unpkg.com/globe.gl"></script>
    <style>
        body { margin: 0; background: #000; color: white; font-family: -apple-system, sans-serif; overflow: hidden; }
        
        #top-bar { position: fixed; top: 0; width: 100%; height: 60px; background: rgba(0,0,0,0.8); z-index: 100; border-bottom: 1px solid #333; display: flex; flex-direction: column; align-items: center; justify-content: center; pointer-events: none; }
        #city-name { font-size: 10px; color: #888; text-transform: uppercase; }
        #station-name { font-size: 14px; font-weight: bold; color: #00ff88; }

        #geo-btn { position: fixed; top: 75px; right: 20px; z-index: 100; background: #222; border: 1px solid #444; border-radius: 50%; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 20px; }

        #sidebar { position: fixed; top: 0; left: -320px; width: 300px; height: 100%; background: #0d0d0d; z-index: 200; transition: 0.3s ease; border-right: 1px solid #333; display: flex; flex-direction: column; }
        #sidebar.open { left: 0; }
        .sidebar-header { padding: 70px 20px 10px; }
        #search-input { width: 100%; padding: 12px; background: #1a1a1a; border: 1px solid #333; border-radius: 8px; color: white; box-sizing: border-box; }

        #station-list { flex: 1; overflow-y: auto; padding: 10px; }
        .station-item { padding: 12px; margin-bottom: 8px; background: #161616; border-radius: 10px; cursor: pointer; font-size: 13px; border: 1px solid transparent; }
        .station-item:hover { border-color: #00ff88; }

        #player-bar { position: fixed; bottom: 0; width: 100%; background: rgba(0,0,0,0.9); padding: 15px; z-index: 150; border-top: 1px solid #333; display: none; box-sizing: border-box; }
        .player-content { display: flex; align-items: center; gap: 12px; max-width: 500px; margin: 0 auto; }
        #volume { flex: 1; accent-color: #00ff88; }
        #timer { font-family: monospace; font-size: 12px; color: #888; }
    </style>
</head>
<body>

    <div id="top-bar">
        <div id="city-name">–ó–ê–ì–†–£–ó–ö–ê...</div>
        <div id="station-name">RADIO WORLD</div>
    </div>

    <div id="geo-btn" onclick="locate()">üìç</div>
    <div id="globeViz"></div>

    <div id="sidebar">
        <div class="sidebar-header">
            <input type="text" id="search-input" placeholder="–ü–æ–∏—Å–∫ —Å—Ç–∞–Ω—Ü–∏–∏..." oninput="filterStations()">
        </div>
        <div id="station-list"></div>
    </div>

    <div id="player-bar">
        <div class="player-content">
            <span>üîà</span>
            <input type="range" id="volume" min="0" max="1" step="0.01" value="0.8">
            <div id="timer">00:00</div>
        </div>
    </div>

    <audio id="audio"></audio>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready(); tg.expand();

        let allCities = []; 
        let currentStations = [];
        let selectedId = null;
        let searchAbort = null;

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ–∫—Å—Ç—É—Ä—ã –¥–ª—è –∫—Ä—É–≥–∞ (—á—Ç–æ–±—ã —Ç–æ—á–∫–∏ –±—ã–ª–∏ —á–µ—Ç–∫–∏–º–∏)
        const markerTexture = (() => {
            const canvas = document.createElement('canvas');
            canvas.width = 64; canvas.height = 64;
            const ctx = canvas.getContext('2d');
            ctx.beginPath(); ctx.arc(32, 32, 30, 0, 2 * Math.PI);
            ctx.fillStyle = '#ffffff'; ctx.fill();
            return new THREE.CanvasTexture(canvas);
        })();

        const world = Globe()(document.getElementById('globeViz'))
            .globeImageUrl('//unpkg.com/three-globe/example/img/earth-night.jpg')
            .backgroundColor('#000000')
            .showAtmosphere(false)
            // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Custom Layer (WebGL) - —Ç–æ—á–∫–∏ –ù–ï –ë–£–î–£–¢ –æ—Ç—Å—Ç–∞–≤–∞—Ç—å
            .customLayerData([])
            .customThreeObject(d => {
                const sprite = new THREE.Sprite(new THREE.SpriteMaterial({ 
                    map: markerTexture, 
                    color: d.type === 'cluster' ? 0x007bff : 0x00ff88 
                }));
                sprite.scale.set(10, 10, 1); // –†–∞–∑–º–µ—Ä –≤ –µ–¥–∏–Ω–∏—Ü–∞—Ö —Å—Ü–µ–Ω—ã
                return sprite;
            })
            .customThreeObjectUpdate((obj, d) => {
                // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø–æ–∑–∏—Ü–∏–∏ —Å –≥–ª–æ–±—É—Å–æ–º
                const coords = world.getCoords(d.lat, d.lng);
                obj.position.set(coords.x, coords.y, coords.z);
                
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ü–≤–µ—Ç–∞ –µ—Å–ª–∏ –≥–æ—Ä–æ–¥ –≤—ã–±—Ä–∞–Ω
                if (d.id === selectedId) {
                    obj.material.color.set('#ffa500');
                    obj.scale.set(14, 14, 1);
                } else {
                    obj.material.color.set(d.type === 'cluster' ? '#007bff' : '#00ff88');
                    obj.scale.set(d.type === 'cluster' ? 14 : 10, d.type === 'cluster' ? 14 : 10, 1);
                }
            });

        const controls = world.controls();
        controls.minDistance = 105;
        controls.maxDistance = 500;

        // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –¥–ª—è WebGL –æ–±—ä–µ–∫—Ç–æ–≤
        world.onCustomLayerClick(d => {
            if (d.type === 'cluster') {
                const pov = world.pointOfView();
                world.pointOfView({ lat: d.lat, lng: d.lng, alt: pov.alt * 0.4 }, 600);
            } else {
                selectCity(d);
            }
        });

        // –ü–æ–∏—Å–∫ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–æ–ª–æ–∂–µ–Ω–∏—è
        controls.addEventListener('change', debounce(() => runSearch(), 800));

        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2-lat1)*Math.PI/180;
            const dLon = (lon2-lon1)*Math.PI/180;
            const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        async function runSearch() {
            const { lat, lng, alt } = world.pointOfView();
            if (searchAbort) searchAbort.abort();
            searchAbort = new AbortController();

            // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º 1000 —Å—Ç–∞–Ω—Ü–∏–π –≤ –≤–∏–¥–∏–º–æ–π –æ–±–ª–∞—Å—Ç–∏ (—Ä–∞–¥–∏—É—Å –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∑—É–º–∞)
            const radius = Math.max(30, alt * 1000);

            try {
                const res = await fetch(`https://de1.api.radio-browser.info/json/stations/search?lat=${lat}&lon=${lng}&radius=${radius}&limit=1000&hidebroken=true&order=clickcount&reverse=true`, { signal: searchAbort.signal });
                const data = await res.json();
                
                data.forEach(s => {
                    const sLat = parseFloat(s.geo_lat);
                    const sLng = parseFloat(s.geo_long);
                    if (!sLat || !sLng) return;

                    const name = (s.state || s.country || "Unknown").trim();
                    const existing = allCities.find(c => getDistance(sLat, sLng, c.lat, c.lng) < 30 || c.name.toLowerCase() === name.toLowerCase());

                    if (!existing) {
                        allCities.push({ id: s.stationuuid, lat: sLat, lng: sLng, name: name });
                    }
                });
                updateMarkers();
            } catch(e) {}
        }

        function updateMarkers() {
            const alt = world.pointOfView().alt;
            const clusterDist = alt * 10; // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –ø–æ—Ä–æ–≥ –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏–∏
            const processed = new Set();
            const results = [];

            for (let i = 0; i < allCities.length; i++) {
                if (processed.has(i)) continue;
                let cluster = [allCities[i]];
                processed.add(i);

                for (let j = i + 1; j < allCities.length; j++) {
                    if (processed.has(j)) continue;
                    const d = Math.sqrt((allCities[i].lat - allCities[j].lat)**2 + (allCities[i].lng - allCities[j].lng)**2);
                    if (d < clusterDist) {
                        cluster.push(allCities[j]);
                        processed.add(j);
                    }
                }

                if (cluster.length > 1) {
                    results.push({ ...cluster[0], type: 'cluster', id: 'cl-' + i });
                } else {
                    results.push({ ...allCities[i], type: 'city' });
                }
            }
            world.customLayerData(results);
            document.getElementById('city-name').innerText = `–ì–û–†–û–î–û–í: ${allCities.length}`;
        }

        async function selectCity(city) {
            selectedId = city.id;
            updateMarkers(); // –ü–µ—Ä–µ–∫—Ä–∞—à–∏–≤–∞–µ–º —Ç–æ—á–∫—É
            
            document.getElementById('city-name').innerText = city.name;
            document.getElementById('sidebar').classList.add('open');
            const list = document.getElementById('station-list');
            list.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞...';

            const res = await fetch(`https://de1.api.radio-browser.info/json/stations/search?lat=${
