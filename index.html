<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Radio Globe Pro</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/globe.gl"></script>
    <style>
        body { margin: 0; background: #000; color: white; font-family: -apple-system, sans-serif; overflow: hidden; }
        
        /* –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å */
        #header { position: fixed; top: 0; width: 100%; height: 60px; background: rgba(0,0,0,0.85); z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; border-bottom: 1px solid #333; pointer-events: none; }
        #cur-city { font-size: 10px; color: #888; text-transform: uppercase; }
        #cur-station { font-size: 14px; font-weight: bold; color: #00ff88; }

        /* –ö–Ω–æ–ø–∫–∞ –ì–µ–æ */
        #geo-btn { position: fixed; top: 75px; right: 20px; z-index: 100; background: #222; border: 1px solid #444; border-radius: 50%; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 20px; }

        /* –ë–æ–∫–æ–≤–æ–µ –º–µ–Ω—é */
        #side-menu { position: fixed; top: 0; left: -320px; width: 300px; height: 100%; background: #0d0d0d; z-index: 200; transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); border-right: 1px solid #333; display: flex; flex-direction: column; }
        #side-menu.open { left: 0; }
        .menu-top { padding: 70px 20px 15px; }
        #search-box { width: 100%; padding: 12px; background: #1a1a1a; border: 1px solid #333; border-radius: 8px; color: white; }

        #list-container { flex: 1; overflow-y: auto; padding: 10px; }
        .station-item { padding: 12px; margin-bottom: 6px; background: #161616; border-radius: 8px; cursor: pointer; font-size: 13px; border: 1px solid transparent; }
        .station-item:hover { border-color: #00ff88; background: #1a1a1a; }

        /* –ù–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å */
        #footer { position: fixed; bottom: 0; width: 100%; background: rgba(0,0,0,0.9); padding: 15px; z-index: 100; border-top: 1px solid #333; display: none; }
        .player-wrap { display: flex; align-items: center; gap: 12px; max-width: 500px; margin: 0 auto; }
        #volume { flex: 1; accent-color: #00ff88; }
        #timer { font-family: monospace; font-size: 12px; color: #888; }

        /* –ö–∞—Å—Ç–æ–º–Ω—ã–µ HTML —Ç–æ—á–∫–∏ –≥–æ—Ä–æ–¥–æ–≤ */
        .city-marker { width: 10px; height: 10px; border-radius: 50%; background: #00ff88; cursor: pointer; transform: translate(-50%, -50%); pointer-events: auto; transition: 0.2s; }
        .city-marker.cluster { width: 16px; height: 16px; background: #007bff; border: 2px solid #fff; }
        .city-marker.active { background: #ffa500; box-shadow: 0 0 10px #ffa500; }
    </style>
</head>
<body>

    <div id="header">
        <div id="cur-city">–í–´–ë–ï–†–ò–¢–ï –¢–û–ß–ö–£</div>
        <div id="cur-station">RADIO PRO</div>
    </div>

    <div id="geo-btn" onclick="useGeo()">üìç</div>

    <div id="globeViz"></div>

    <div id="side-menu">
        <div class="menu-top">
            <input type="text" id="search-box" placeholder="–ü–æ–∏—Å–∫ –≤ —ç—Ç–æ–º –≥–æ—Ä–æ–¥–µ..." oninput="filterList()">
        </div>
        <div id="list-container"></div>
    </div>

    <div id="footer">
        <div class="player-wrap">
            <span>üîà</span>
            <input type="range" id="volume" min="0" max="1" step="0.01" value="0.8">
            <div id="timer">00:00</div>
        </div>
    </div>

    <audio id="player"></audio>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready(); tg.expand();

        let cities = []; // {id, lat, lng, name, type}
        let rawStations = []; // –°—Ç–∞–Ω—Ü–∏–∏ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –≥–æ—Ä–æ–¥–∞
        let selectedId = null;
        let abortSearch = null;

        const world = Globe()(document.getElementById('globeViz'))
            .globeImageUrl('//unpkg.com/three-globe/example/img/earth-night.jpg')
            .backgroundColor('#000000')
            .showAtmosphere(false)
            .htmlElementsData([])
            .htmlElement(d => {
                const el = document.createElement('div');
                el.className = `city-marker ${d.type === 'cluster' ? 'cluster' : ''} ${d.id === selectedId ? 'active' : ''}`;
                el.onclick = () => d.type === 'cluster' ? zoomToCluster(d) : onCityClick(d);
                return el;
            });

        const ctrl = world.controls();
        ctrl.minDistance = 105;
        ctrl.maxDistance = 500;

        // –ü–æ–∏—Å–∫ –ø—Ä–∏ –∫–∞–∂–¥–æ–º –¥–≤–∏–∂–µ–Ω–∏–∏
        ctrl.addEventListener('change', debounce(() => runSearch(), 800));

        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2-lat1)*Math.PI/180;
            const dLon = (lon2-lon1)*Math.PI/180;
            const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        async function runSearch() {
            const { lat, lng, alt } = world.pointOfView();
            if (abortSearch) abortSearch.abort();
            abortSearch = new AbortController();

            // –ò—Ç–µ—Ä–∞—Ü–∏–∏: –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ –æ—Ö–≤–∞—Ç–∞ –¥–æ 30–∫–º
            const steps = [alt * 800, 300, 100, 30];
            for (let r of steps) {
                if (abortSearch.signal.aborted) break;
                try {
                    const res = await fetch(`https://de1.api.radio-browser.info/json/stations/search?lat=${lat}&lon=${lng}&radius=${r}&limit=100&hidebroken=true&order=clickcount&reverse=true`, { signal: abortSearch.signal });
                    const data = await res.json();
                    mergeStationsToCities(data);
                } catch(e) {}
            }
        }

        function mergeStationsToCities(data) {
            data.forEach(s => {
                const sLat = parseFloat(s.geo_lat);
                const sLng = parseFloat(s.geo_long);
                if (!sLat || !sLng) return;

                // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞–∑–≤–∞–Ω–∏—è
                const name = (s.state || s.country || "Unknown").trim();
                
                // –ò—â–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –≥–æ—Ä–æ–¥ –≤ —Ä–∞–¥–∏—É—Å–µ 30–∫–º –ò–õ–ò —Å —Ç–∞–∫–∏–º –∂–µ –∏–º–µ–Ω–µ–º (–Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–º)
                let existing = cities.find(c => 
                    getDistance(sLat, sLng, c.lat, c.lng) < 30 || 
                    c.name.toLowerCase() === name.toLowerCase()
                );

                if (!existing) {
                    cities.push({ id: s.stationuuid, lat: sLat, lng: sLng, name: name, type: 'city' });
                }
            });
            refreshMarkers();
        }

        function refreshMarkers() {
            const alt = world.pointOfView().alt;
            const threshold = alt * 10; // –ü–æ—Ä–æ–≥ —Å—Ö–ª–æ–ø—ã–≤–∞–Ω–∏—è –≤ —Å–∏–Ω–∏–π –∫—Ä—É–≥
            const displayed = [];
            const processed = new Set();

            for (let i = 0; i < cities.length; i++) {
                if (processed.has(i)) continue;
                let cluster = [cities[i]];
                processed.add(i);

                for (let j = i + 1; j < cities.length; j++) {
                    if (processed.has(j)) continue;
                    const d = Math.sqrt((cities[i].lat - cities[j].lat)**2 + (cities[i].lng - cities[j].lng)**2);
                    if (d < threshold) {
                        cluster.push(cities[j]);
                        processed.add(j);
                    }
                }

                if (cluster.length > 1) {
                    displayed.push({ ...cluster[0], type: 'cluster', id: 'cl-' + i });
                } else {
                    displayed.push(cities[i]);
                }
            }
            world.htmlElementsData(displayed);
        }

        function zoomToCluster(d) {
            const pos = world.pointOfView();
            world.pointOfView({ lat: d.lat, lng: d.lng, alt: pos.alt * 0.4 }, 800);
        }

        async function onCityClick(city) {
            selectedId = city.id;
            refreshMarkers();
            
            document.getElementById('cur-city').innerText = city.name;
            document.getElementById('side-menu').classList.add('open');
            const list = document.getElementById('list-container');
            list.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞...';

            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞–Ω—Ü–∏–∏ –¢–û–õ–¨–ö–û –¥–ª—è —ç—Ç–æ–≥–æ –≥–æ—Ä–æ–¥–∞ (—Ä–∞–¥–∏—É—Å 30–∫–º)
            const res = await fetch(`https://de1.api.radio-browser.info/json/stations/search?lat=${city.lat}&lon=${city.lng}&radius=35&limit=150&hidebroken=true&order=clickcount&reverse=true`);
            rawStations = await res.json();
            renderList(rawStations);
        }

        function renderList(arr) {
            const list = document.getElementById('list-container');
            list.innerHTML = '';
            arr.forEach(s => {
                const item = document.createElement('div');
                item.className = 'station-item';
                item.innerText = s.name;
                item.onclick = () => play(s);
                list.appendChild(item);
            });
        }

        function play(s) {
            document.getElementById('cur-station').innerText = s.name;
            document.getElementById('footer').style.display = 'block';
            const audio = document.getElementById('player');
            audio.src = s.url_resolved.replace('http://', 'https://');
            audio.play();
            if (window.innerWidth < 600) document.getElementById('side-menu').classList.remove('open');
        }

        function filterList() {
            const query = document.getElementById('search-box').value.toLowerCase();
            const filtered = rawStations.filter(s => s.name.toLowerCase().includes(query));
            renderList(filtered);
        }

        function useGeo() {
            navigator.geolocation.getCurrentPosition(pos => {
                const { latitude, longitude } = pos.coords;
                world.pointOfView({ lat: latitude, lng: longitude, alt: 0.8 }, 1000);
                setTimeout(runSearch, 1100);
            });
        }

        function debounce(f, ms) { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => f.apply(this, a), ms); }; }

        // –¢–∞–π–º–µ—Ä –∏ –≥—Ä–æ–º–∫–æ—Å—Ç—å
        const p = document.getElementById('player');
        p.ontimeupdate = () => {
            const m = Math.floor(p.currentTime / 60);
            const s = Math.floor(p.currentTime % 60);
            document.getElementById('timer').innerText = `${m}:${s < 10 ? '0' : ''}${s}`;
        };
        document.getElementById('volume').oninput = (e) => p.volume = e.target.value;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        setTimeout(runSearch, 1000);
    </script>
</body>
</html>
