<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Radio Pro Max: Pixel Clustering</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/globe.gl"></script>
    <style>
        body { margin: 0; background: #000; color: white; font-family: -apple-system, system-ui, sans-serif; overflow: hidden; }
        
        #status-bar {
            position: fixed; top: 0; width: 100%; background: rgba(0,0,0,0.95);
            padding: 12px; text-align: center; border-bottom: 1px solid #333; z-index: 1005; display: none;
            backdrop-filter: blur(5px);
        }
        #status-station { font-size: 14px; font-weight: bold; color: #00ff88; }

        #scanner-info {
            position: fixed; top: 15px; right: 15px; background: rgba(0,255,136,0.1);
            color: #00ff88; padding: 5px 12px; border-radius: 15px; font-size: 10px; z-index: 1001;
        }

        /* –°—Ç–∏–ª–∏ –º–∞—Ä–∫–µ—Ä–æ–≤ */
        .dot { border-radius: 50%; cursor: pointer; transform: translate(-50%, -50%); border: 1px solid rgba(0,0,0,0.3); transition: transform 0.2s; }
        
        /* –û–¥–∏–Ω–æ—á–Ω—ã–π –≥–æ—Ä–æ–¥ */
        .dot-city { width: 10px; height: 10px; background: #00ff88; box-shadow: 0 0 8px #00ff88; }
        
        /* –ö–ª–∞—Å—Ç–µ—Ä (–°–∏–Ω–∏–π) */
        .dot-cluster { 
            width: 24px; height: 24px; background: #007bff; border: 2px solid #fff;
            display: flex; align-items: center; justify-content: center; 
            font-size: 10px; font-weight: bold; color: white; box-shadow: 0 0 12px #007bff;
        }
        
        /* –ê–∫—Ç–∏–≤–Ω—ã–π –≥–æ—Ä–æ–¥ */
        .dot-active { background: #ffa500 !important; box-shadow: 0 0 15px #ffa500; width: 14px; height: 14px; z-index: 1000; }

        #menu-btn { position: fixed; top: 65px; left: 15px; z-index: 1001; background: #222; border-radius: 50%; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 1px solid #444; }

        #side-drawer {
            position: fixed; top: 0; left: -320px; width: 280px; height: 100%;
            background: #0d0d0d; z-index: 1002; transition: 0.3s ease; display: flex; flex-direction: column; border-right: 1px solid #333;
        }
        #side-drawer.open { left: 0; }
        .drawer-header { padding: 80px 20px 15px; }
        #search-input { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #333; background: #1a1a1a; color: #fff; outline: none; box-sizing: border-box; }

        #stations-list { flex: 1; overflow-y: auto; padding: 10px; }
        .city-group { margin-bottom: 8px; background: #161616; border-radius: 10px; border: 1px solid #222; overflow: hidden; }
        .city-name { padding: 12px; font-size: 14px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .city-group.active .station-sub-item { display: block; background: #0f0f0f; }
        .station-sub-item { padding: 12px; font-size: 13px; border-top: 1px solid #222; color: #aaa; display: none; cursor: pointer; }

        #player-container {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; background: #111; padding: 15px; border-radius: 20px; z-index: 1100; border: 1px solid #333; display: none;
        }
    </style>
</head>
<body>

    <div id="status-bar"><div id="status-city">–ì–û–†–û–î</div><div id="status-station">–ù–∞–∑–≤–∞–Ω–∏–µ</div></div>
    <div id="scanner-info">–ì–û–†–û–î–û–í: 0</div>
    <div id="menu-btn">‚ò∞</div>
    <div id="globeViz"></div>

    <div id="side-drawer">
        <div class="drawer-header"><input type="text" id="search-input" placeholder="–ü–æ–∏—Å–∫ –≥–æ—Ä–æ–¥–∞..."></div>
        <div id="stations-list"></div>
    </div>

    <div id="player-container">
        <div style="display: flex; align-items: center; gap: 12px;">
            <span>üîà</span>
            <input type="range" id="volume-control" min="0" max="1" step="0.01" value="0.8" style="flex:1; accent-color: #00ff88;">
            <div id="time-display" style="font-size:12px; color:#888;">00:00</div>
        </div>
        <audio id="audio-player"></audio>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready(); tg.expand();

        let allGroups = [];
        let currentActiveGroupKey = null;
        let offset = 0;
        const audioPlayer = document.getElementById('audio-player');
        
        const world = Globe()(document.getElementById('globeViz'))
            .globeImageUrl('https://unpkg.com/three-globe/example/img/earth-night.jpg')
            .backgroundColor('#000000')
            .showAtmosphere(false)
            .htmlElementsData([])
            .htmlElement(d => {
                const el = document.createElement('div');
                const groupKey = (d.city + d.lat).toLowerCase();
                
                if (d.isCluster) {
                    el.className = 'dot dot-cluster';
                    el.innerHTML = d.count;
                    el.onclick = () => {
                        const pov = world.pointOfView();
                        world.pointOfView({ lat: d.lat, lng: d.lng, alt: pov.alt * 0.4 }, 600);
                    };
                } else {
                    el.className = 'dot dot-city';
                    if (currentActiveGroupKey === groupKey) el.classList.add('dot-active');
                    el.onclick = () => openCityUI(d, groupKey);
                }
                return el;
            });

        // –°–ª—É—à–∞—Ç–µ–ª—å –¥–≤–∏–∂–µ–Ω–∏—è –∫–∞–º–µ—Ä—ã –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–π –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏–∏
        world.controls().addEventListener('change', debounce(() => updateClusters(), 100));

        function debounce(f, ms) { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => f.apply(this, a), ms); }; }

        function updateClusters() {
            if (!allGroups.length) return;

            const THRESHOLD = 30; // –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –≤ –ø–∏–∫—Å–µ–ª—è—Ö –¥–ª—è –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è
            const visibleData = [];
            const processed = new Set();

            // –ü—Ä–æ–µ—Ü–∏—Ä—É–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤ —ç–∫—Ä–∞–Ω–Ω—ã–µ –ø–∏–∫—Å–µ–ª–∏
            const points = allGroups.map((g, idx) => {
                const pos = world.getScreenCoords(g.lat, g.lng);
                return { ...g, x: pos ? pos.x : -1000, y: pos ? pos.y : -1000, id: idx };
            });

            for (let i = 0; i < points.length; i++) {
                if (processed.has(i)) continue;

                let cluster = [points[i]];
                processed.add(i);

                for (let j = i + 1; j < points.length; j++) {
                    if (processed.has(j)) continue;
                    
                    const dx = points[i].x - points[j].x;
                    const dy = points[i].y - points[j].y;
                    const dist = Math.sqrt(dx*dx + dy*dy);

                    if (dist < THRESHOLD) {
                        cluster.push(points[j]);
                        processed.add(j);
                    }
                }

                if (cluster.length > 1) {
                    visibleData.push({
                        lat: cluster[0].lat, lng: cluster[0].lng,
                        count: cluster.length, isCluster: true
                    });
                } else {
                    visibleData.push({ ...cluster[0], isCluster: false });
                }
            }
            world.htmlElementsData(visibleData);
        }

        async function backgroundScanner() {
            try {
                const res = await fetch(`https://de1.api.radio-browser.info/json/stations/search?limit=1000&offset=${offset}&has_geo_info=true&hidebroken=true&order=clickcount&reverse=true`);
                const data = await res.json();
                if (!data.length) return;

                data.forEach(s => {
                    const lat = parseFloat(s.geo_lat), lng = parseFloat(s.geo_long);
                    const city = s.state || s.country || 'Unknown';
                    let exist = allGroups.find(g => Math.abs(g.lat - lat) < 0.1 && Math.abs(g.lng - lng) < 0.1);
                    if (exist) {
                        if (!exist.stations.find(st => st.stationuuid === s.stationuuid)) exist.stations.push(s);
                    } else {
                        allGroups.push({ lat, lng, city, searchTag: (city + ' ' + (s.tags || '')).toLowerCase(), stations: [s] });
                    }
                });

                document.getElementById('scanner-info').innerText = `–ì–û–†–û–î–û–í: ${allGroups.length}`;
                updateClusters();
                offset += 1000;
            } catch (e) {}
        }

        function openCityUI(d, key) {
            currentActiveGroupKey = key;
            world.pointOfView({ lat: d.lat, lng: d.lng, alt: 1.1 }, 600);
            updateClusters();
            
            const list = document.getElementById('stations-list');
            list.innerHTML = '';
            const div = document.createElement('div');
            div.className = 'city-group active';
            div.innerHTML = `<div class="city-name"><span>${d.city}</span><small>${d.stations.length}</small></div>`;
            d.stations.forEach(s => {
                const sDiv = document.createElement('div');
                sDiv.className = 'station-sub-item';
                sDiv.style.display = 'block';
                sDiv.innerText = s.name;
                sDiv.onclick = (e) => { e.stopPropagation(); play(s, d, key); };
                div.appendChild(sDiv);
            });
            list.appendChild(div);
            document.getElementById('side-drawer').classList.add('open');
        }

        function play(s, g, key) {
            currentActiveGroupKey = key;
            updateClusters();
            document.getElementById('status-bar').style.display = 'block';
            document.getElementById('status-city').innerText = g.city;
            document.getElementById('status-station').innerText = s.name;
            audioPlayer.src = s.url_resolved.replace('http://', 'https://');
            document.getElementById('player-container').style.display = 'block';
            audioPlayer.play();
            if (window.innerWidth < 600) document.getElementById('side-drawer').classList.remove('open');
        }

        document.getElementById('menu-btn').onclick = () => document.getElementById('side-drawer').classList.toggle('open');
        world.onGlobeClick(() => document.getElementById('side-drawer').classList.remove('open'));
        
        backgroundScanner();
        setInterval(backgroundScanner, 4000);
    </script>
</body>
</html>
